<div class="team-detail-container">
  <header class="team-detail-header">
    <button (click)="goBack()" class="back-button">← Back to Dashboard</button>
  </header>

  @if (team()) {
    <main class="team-detail-content">
      <div class="team-info-card">
        <div class="team-info-header">
          <div>
            <h1>{{ team()?.name }}</h1>
            <p class="team-number">Team #{{ team()?.teamNumber }}</p>
          </div>
          <div class="header-actions">
            @if (isTeamAdmin()) {
              <button (click)="openRoleEditor()" class="edit-roles-button">
                Edit Team Roles
              </button>
              <button (click)="openConstraintsEditor()" class="edit-constraints-button">
                Edit Constraints
              </button>
              <button (click)="openImportDialog()" class="import-roster-button">
                Import Roster
              </button>
              <button (click)="openInviteDialog()" class="invite-button">
                Invite Member
              </button>
            }
            <span class="visibility-badge {{ team()?.visibility }}">
              {{ team()?.visibility | titlecase }}
            </span>
          </div>
        </div>
        
        @if (team()?.description) {
          <p class="team-description">{{ team()?.description }}</p>
        }

        <div class="team-stats">
          <div class="stat">
            <span class="stat-label">Active Members</span>
            <span class="stat-value">{{ activeMembers().length }}</span>
          </div>
          <div class="stat">
            <span class="stat-label">Pending Requests</span>
            <span class="stat-value pending">{{ pendingMembers().length }}</span>
          </div>
        </div>
      </div>

      @if (pendingMembers().length > 0) {
        <div class="members-card">
          <button 
            class="collapsible-header" 
            (click)="togglePendingMembers()"
            [class.active]="showPendingMembers()">
            <span class="chevron">{{ showPendingMembers() ? '▼' : '▶' }}</span>
            <h2>Pending Membership Requests ({{ pendingMembers().length }})</h2>
          </button>

          @if (showPendingMembers()) {
            <div class="collapsible-content">
              @if (isLoadingMembers()) {
                <p class="loading-message">Loading members...</p>
              } @else {
                <div class="members-list">
                  @for (member of pendingMembers(); track member.userId) {
                    <div class="member-item pending">
                      <div class="member-info">
                        <div class="member-name">
                          {{ member.user?.fullName || 'Unknown User' }}
                        </div>
                        @if (member.user?.primaryEmail) {
                          <div class="member-email">{{ member.user?.primaryEmail }}</div>
                        }
                        @if (member.user?.primaryPhone) {
                          <div class="member-phone">{{ member.user?.primaryPhone }}</div>
                        }
                        <div class="member-roles">
                          <span class="role-tag">{{ member.roles.join(', ') }}</span>
                        </div>
                      </div>
                      <div class="member-actions">
                        <button 
                          class="approve-button"
                          (click)="approveMember(member.userId)">
                          Approve
                        </button>
                        <button 
                          class="reject-button"
                          (click)="rejectMember(member.userId)">
                          Reject
                        </button>
                      </div>
                    </div>
                  }
                </div>
              }
            </div>
          }
        </div>
      }

      <div class="members-card">
        <button 
          class="collapsible-header" 
          (click)="toggleActiveMembers()"
          [class.active]="showActiveMembers()">
          <span class="chevron">{{ showActiveMembers() ? '▼' : '▶' }}</span>
          <h2>Team Members ({{ activeMembers().length }})</h2>
        </button>

        @if (showActiveMembers()) {
          <div class="collapsible-content">
            @if (isLoadingMembers()) {
              <p class="loading-message">Loading members...</p>
            } @else if (activeMembers().length === 0) {
              <p class="empty-message">No active members.</p>
            } @else {
              <div class="members-list">
                @for (member of activeMembers(); track member.userId) {
                  <div class="member-item active" [class.disabled]="member.user?.isActive === false">
                    <div class="member-info">
                      <div class="member-name">
                        {{ member.user?.fullName || 'Unknown User' }}
                        @if (member.user?.isActive === false) {
                          <span class="disabled-badge">Disabled</span>
                        }
                      </div>
                      @if (member.user?.primaryEmail) {
                        <div class="member-email">{{ member.user?.primaryEmail }}</div>
                      }
                      @if (member.user?.primaryPhone) {
                        <div class="member-phone">{{ member.user?.primaryPhone }}</div>
                      }
                      
                      @if (isTeamAdmin()) {
                        <div class="member-roles-edit">
                          <label>Roles:</label>
                          <div class="roles-checkboxes">
                            @for (role of availableRoles(); track role) {
                              <label class="role-checkbox">
                                <input 
                                  type="checkbox"
                                  [checked]="memberHasRole(member, role)"
                                  (change)="toggleMemberRole(member.userId, role, $event)"
                                  [disabled]="isUpdatingMemberRoles()"
                                />
                                <span>{{ role }}</span>
                              </label>
                            }
                          </div>
                        </div>
                      } @else {
                        <div class="member-roles">
                          @for (role of member.roles; track role) {
                            <span class="role-tag">{{ role }}</span>
                          }
                        </div>
                      }
                    </div>
                    <div class="member-status">
                      <span class="status-badge active">Active</span>
                      @if (isTeamAdmin()) {
                        <button 
                          class="toggle-active-button"
                          [class.enable]="member.user?.isActive === false"
                          [class.disable]="member.user?.isActive !== false"
                          (click)="toggleUserActiveStatus(member.userId, member.user?.isActive !== false)">
                          {{ member.user?.isActive === false ? 'Enable' : 'Disable' }}
                        </button>
                      }
                    </div>
                  </div>
                }
              </div>
            }
          </div>
        }
      </div>
    </main>
  } @else {
    <div class="loading-container">
      <p class="loading-message">Loading team details...</p>
    </div>
  }
</div>

@if (showRoleEditor()) {
  <div class="dialog-overlay" (click)="closeRoleEditor()">
    <div class="dialog-content role-editor" (click)="$event.stopPropagation()">
      <div class="dialog-header">
        <h2>Edit Roles</h2>
        <button class="close-button" (click)="closeRoleEditor()">×</button>
      </div>

      <div class="role-editor-content">
        <p class="editor-description">
          Manage the available roles for this team. The Administrator role cannot be deleted.
        </p>

        <div class="current-roles">
          <h3>Current Roles</h3>
          <div class="roles-list">
            @for (role of editingRoles(); track role) {
              <div class="role-item" [class.protected]="role === 'Administrator'">
                <span class="role-name">{{ role }}</span>
                @if (role === 'Administrator') {
                  <span class="protected-badge">Protected</span>
                } @else {
                  <button 
                    class="remove-role-button"
                    (click)="removeRoleFromEditor(role)"
                    [disabled]="isSavingRoles()">
                    Remove
                  </button>
                }
              </div>
            }
          </div>
        </div>

        <div class="add-role-section">
          <h3>Add New Role</h3>
          <div class="add-role-form">
            <input 
              type="text"
              [(ngModel)]="newRoleName"
              placeholder="Enter role name"
              [disabled]="isSavingRoles()"
              (keyup.enter)="addRoleToEditor()"
            />
            <button 
              class="add-role-button"
              (click)="addRoleToEditor()"
              [disabled]="!newRoleName().trim() || isSavingRoles()">
              Add Role
            </button>
          </div>
        </div>

        @if (roleEditorError()) {
          <div class="alert-error">
            {{ roleEditorError() }}
          </div>
        }

        <div class="dialog-actions">
          <button 
            class="cancel-button"
            (click)="closeRoleEditor()"
            [disabled]="isSavingRoles()">
            Cancel
          </button>
          <button 
            class="save-button"
            (click)="saveRoles()"
            [disabled]="isSavingRoles()">
            {{ isSavingRoles() ? 'Saving...' : 'Save Changes' }}
          </button>
        </div>
      </div>
    </div>
  </div>
}

@if (showInviteDialog()) {
  <div class="dialog-overlay" (click)="closeInviteDialog()">
    <div class="dialog-content invite-dialog" (click)="$event.stopPropagation()">
      <div class="dialog-header">
        <h2>Invite Member to Team</h2>
        <button class="close-button" (click)="closeInviteDialog()">×</button>
      </div>

      <div class="invite-content">
        <p class="dialog-description">
          Enter the email address of the person you want to invite to join {{ team()?.name }}.
          They will receive an email invitation.
        </p>

        <div class="invite-form">
          <label for="inviteEmail">Email Address</label>
          <input 
            id="inviteEmail"
            type="email"
            [(ngModel)]="inviteEmail"
            placeholder="user@example.com"
            [disabled]="isSendingInvitation()"
            (keyup.enter)="sendInvitation()"
          />
          <button 
            class="send-button"
            (click)="sendInvitation()"
            [disabled]="!inviteEmail().trim() || isSendingInvitation()">
            {{ isSendingInvitation() ? 'Sending...' : 'Send Invitation' }}
          </button>
        </div>

        @if (invitationError()) {
          <div class="alert-error">
            {{ invitationError() }}
          </div>
        }

        <div class="invitations-list">
          <h3>Pending Invitations</h3>
          @if (teamInvitations().length === 0) {
            <p class="no-invitations">No pending invitations</p>
          } @else {
            <div class="invitations">
              @for (invitation of teamInvitations(); track invitation.id) {
                <div class="invitation-item" [class.status]="invitation.status">
                  <div class="invitation-email">{{ invitation.email }}</div>
                  <div class="invitation-status">{{ invitation.status }}</div>
                  <div class="invitation-date">{{ invitation.createdAt | date:'short' }}</div>
                </div>
              }
            </div>
          }
        </div>

        <div class="dialog-actions">
          <button 
            class="cancel-button"
            (click)="closeInviteDialog()">
            Close
          </button>
        </div>
      </div>
    </div>
  </div>
}

@if (showConstraintsEditor()) {
  <div class="dialog-overlay" (click)="closeConstraintsEditor()">
    <div class="dialog-content constraints-editor" (click)="$event.stopPropagation()">
      <div class="dialog-header">
        <h2>
          Edit Role Constraints
          <span class="help-icon" title="This establishes pairs of team roles that a member cannot have at the same time.">ℹ️</span>
        </h2>
        <button class="close-button" (click)="closeConstraintsEditor()">×</button>
      </div>

      <div class="constraints-editor-content">
        <p class="editor-description">
          Role constraints define pairs of roles that cannot be assigned to the same member simultaneously.
          For example, if you create a constraint between "Mentor" and "Student", a member cannot be both a Mentor and a Student at the same time.
        </p>

        <div class="current-constraints">
          <h3>Current Constraints</h3>
          @if (editingConstraints().length === 0) {
            <p class="no-constraints">No constraints defined. Members can have any combination of roles.</p>
          } @else {
            <div class="constraints-list">
              @for (constraint of editingConstraints(); track $index) {
                <div class="constraint-item">
                  <span class="constraint-pair">
                    <span class="role-name">{{ constraint[0] }}</span>
                    <span class="constraint-separator">↔</span>
                    <span class="role-name">{{ constraint[1] }}</span>
                  </span>
                  <button 
                    class="remove-constraint-button"
                    (click)="removeConstraint($index)"
                    [disabled]="isSavingConstraints()">
                    Remove
                  </button>
                </div>
              }
            </div>
          }
        </div>

        <div class="add-constraint-section">
          <h3>Add New Constraint</h3>
          <div class="add-constraint-form">
            <div class="form-group">
              <label for="constraintRole1">First Role</label>
              <select 
                id="constraintRole1"
                [(ngModel)]="constraintRole1"
                [disabled]="isSavingConstraints()">
                <option value="">Select a role</option>
                @for (role of availableRoles(); track role) {
                  <option [value]="role">{{ role }}</option>
                }
              </select>
            </div>
            <div class="constraint-arrow">↔</div>
            <div class="form-group">
              <label for="constraintRole2">Second Role</label>
              <select 
                id="constraintRole2"
                [(ngModel)]="constraintRole2"
                [disabled]="isSavingConstraints()">
                <option value="">Select a role</option>
                @for (role of availableRoles(); track role) {
                  <option [value]="role">{{ role }}</option>
                }
              </select>
            </div>
            <button 
              class="add-constraint-button"
              (click)="addConstraint()"
              [disabled]="!constraintRole1() || !constraintRole2() || isSavingConstraints()">
              Add Constraint
            </button>
          </div>
        </div>

        @if (constraintsEditorError()) {
          <div class="alert-error">
            {{ constraintsEditorError() }}
          </div>
        }

        <div class="dialog-actions">
          <button 
            class="cancel-button"
            (click)="closeConstraintsEditor()"
            [disabled]="isSavingConstraints()">
            Cancel
          </button>
          <button 
            class="save-button"
            (click)="saveConstraints()"
            [disabled]="isSavingConstraints()">
            {{ isSavingConstraints() ? 'Saving...' : 'Save Changes' }}
          </button>
        </div>
      </div>
    </div>
  </div>
}

@if (showImportDialog()) {
  <div class="dialog-overlay" (click)="closeImportDialog()">
    <div class="dialog-content import-roster-dialog" (click)="$event.stopPropagation()">
      <div class="dialog-header">
        <h2>Import Team Roster</h2>
        <button class="close-button" (click)="closeImportDialog()">×</button>
      </div>

      <div class="import-content">
        <p class="dialog-description">
          Upload a CSV file with team members. Required columns: <strong>First</strong>, <strong>Last</strong>, <strong>Email</strong>.<br>
          Optional columns: Address, City, State, Zip, Phone Number<br>
          <small>For multiple phone numbers, separate them with semicolons (e.g., "555-1234;555-5678")</small>
        </p>

        <div class="member-status-selector">
          <label>New user account status:</label>
          <div class="status-options">
            <label class="radio-option">
              <input 
                type="radio" 
                name="importStatus" 
                value="pending"
                [checked]="importStatus() === 'pending'"
                (change)="importStatus.set('pending')"
                [disabled]="isImporting()"
              />
              <span>Pending (requires email verification to login)</span>
            </label>
            <label class="radio-option">
              <input 
                type="radio" 
                name="importStatus" 
                value="active"
                [checked]="importStatus() === 'active'"
                (change)="importStatus.set('active')"
                [disabled]="isImporting()"
              />
              <span>Active (can login immediately)</span>
            </label>
          </div>
        </div>

        <div class="default-password-field">
          <label for="defaultPassword">Default Password (optional):</label>
          <input 
            type="text" 
            id="defaultPassword" 
            [value]="importDefaultPassword()"
            (input)="importDefaultPassword.set($any($event.target).value)"
            [disabled]="isImporting()"
            placeholder="Leave empty for random passwords"
            class="password-input"
          />
          <p class="field-hint">If provided, all new users will be created with this password. Leave empty to generate random passwords.</p>
        </div>

        <div 
          class="file-upload-area"
          [class.dragging]="isDragging()"
          (dragover)="onDragOver($event)"
          (dragleave)="onDragLeave($event)"
          (drop)="onDrop($event)">
          <div class="upload-icon">📁</div>
          <p class="upload-text">Drag and drop CSV file here</p>
          <p class="upload-or">or</p>
          <input 
            type="file" 
            id="rosterFile" 
            accept=".csv"
            (change)="onFileSelected($event)"
            [disabled]="isImporting()"
            hidden
          />
          <label for="rosterFile" class="browse-button">
            Browse Files
          </label>
          @if (importFile()) {
            <div class="selected-file">
              <span class="file-name">📄 {{ importFile()?.name }}</span>
              <button 
                class="remove-file-button"
                (click)="importFile.set(null); $event.stopPropagation()"
                [disabled]="isImporting()">
                ×
              </button>
            </div>
          }
        </div>

        @if (isImporting()) {
          <div class="progress-container">
            <div class="progress-header">
              <span class="progress-label">Importing roster...</span>
              <span class="progress-percentage">{{ importProgress().toFixed(0) }}%</span>
            </div>
            <div class="progress-bar">
              <div 
                class="progress-fill" 
                [style.width.%]="importProgress()">
              </div>
            </div>
            @if (importTotal() > 0) {
              <div class="progress-details">
                Processing {{ importTotal() }} members
              </div>
            }
          </div>
        }

        @if (importError()) {
          <div class="alert-error">
            {{ importError() }}
          </div>
        }

        @if (importResult()) {
          <div class="import-results">
            <h3>Import Results</h3>
            <div class="results-summary">
              <div class="result-stat success">
                <span class="stat-label">Successful:</span>
                <span class="stat-value">{{ importResult().successful }}</span>
              </div>
              <div class="result-stat error">
                <span class="stat-label">Failed:</span>
                <span class="stat-value">{{ importResult().failed }}</span>
              </div>
            </div>

            @if (importResult().created.length > 0) {
              <div class="result-section">
                <h4>New Users Created ({{ importResult().created.length }})</h4>
                <div class="result-list">
                  @for (user of importResult().created; track user.email) {
                    <div class="result-item">{{ user.name }} ({{ user.email }})</div>
                  }
                </div>
              </div>
            }

            @if (importResult().existing.length > 0) {
              <div class="result-section">
                <h4>Existing Users Added to Team ({{ importResult().existing.length }})</h4>
                <div class="result-list">
                  @for (user of importResult().existing; track user.email) {
                    <div class="result-item">{{ user.name }} ({{ user.email }})</div>
                  }
                </div>
              </div>
            }

            @if (importResult().errors.length > 0) {
              <div class="result-section errors">
                <h4>Errors ({{ importResult().errors.length }})</h4>
                <div class="result-list">
                  @for (error of importResult().errors; track error.row) {
                    <div class="result-item error">
                      Row {{ error.row }}: {{ error.error }}
                      @if (error.email) {
                        <span class="error-email">({{ error.email }})</span>
                      }
                    </div>
                  }
                </div>
              </div>
            }
          </div>
        }

        <div class="dialog-actions">
          <button 
            class="cancel-button"
            (click)="closeImportDialog()"
            [disabled]="isImporting()">
            {{ importResult() ? 'Close' : 'Cancel' }}
          </button>
          @if (!importResult()) {
            <button 
              class="import-button"
              (click)="importRoster()"
              [disabled]="!importFile() || isImporting()">
              {{ isImporting() ? 'Importing...' : 'Import Roster' }}
            </button>
          }
        </div>
      </div>
    </div>
  </div>
}
