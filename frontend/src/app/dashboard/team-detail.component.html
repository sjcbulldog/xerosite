<div class="team-detail-container">
  <header class="team-detail-header">
    <button (click)="goBack()" class="back-button">‚Üê Back to Dashboard</button>
  </header>

  @if (team()) {
    <main class="team-detail-content">
      <div class="team-info-card">
        <div class="team-info-header">
          <div>
            <h1>{{ team()?.name }}</h1>
            <p class="team-number">Team #{{ team()?.teamNumber }}</p>
          </div>
          <div class="header-actions">
            <span class="visibility-badge {{ team()?.visibility }}">
              {{ team()?.visibility | titlecase }}
            </span>
            @if (isTeamAdmin()) {
              <div class="admin-menu-container">
                <button (click)="toggleAdminMenu()" class="hamburger-button" [class.active]="showAdminMenu()">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                  </svg>
                </button>
                @if (showAdminMenu()) {
                  <div class="admin-menu-dropdown">
                    <button (click)="openDescriptionEditor()" class="menu-item">
                      <span class="menu-icon">üìù</span>
                      Edit Team Information
                    </button>                    
                    <button (click)="openRoleEditor()" class="menu-item">
                      <span class="menu-icon">üé≠</span>
                      Edit Team Roles
                    </button>
                    <button (click)="openConstraintsEditor()" class="menu-item">
                      <span class="menu-icon">‚öñÔ∏è</span>
                      Edit Role Constraints
                    </button>
                    <button (click)="openInviteDialog()" class="menu-item">
                      <span class="menu-icon">‚úâÔ∏è</span>
                      Invite Member
                    </button>                    
                    <button (click)="openImportDialog()" class="menu-item">
                      <span class="menu-icon">üìã</span>
                      Import Roster
                    </button>
                  </div>
                }
              </div>
            }
          </div>
        </div>
        
        <div class="team-description-section">
          @if (team()?.description) {
            <p class="team-description">{{ team()?.description }}</p>
          } @else if (isTeamAdmin()) {
            <p class="team-description empty">No description set</p>
          }
        </div>

        <div class="team-stats">
          <div class="stat">
            <span class="stat-label">Active Members</span>
            <span class="stat-value">{{ activeMembers().length }}</span>
          </div>
          <div class="stat">
            <span class="stat-label">Pending Requests</span>
            <span class="stat-value pending">{{ pendingMembers().length }}</span>
          </div>
        </div>
      </div>

      @if (pendingMembers().length > 0) {
        <div class="members-card">
          <button 
            class="collapsible-header" 
            (click)="togglePendingMembers()"
            [class.active]="showPendingMembers()">
            <span class="chevron">{{ showPendingMembers() ? '‚ñº' : '‚ñ∂' }}</span>
            <h2>Pending Membership Requests ({{ pendingMembers().length }})</h2>
          </button>

          @if (showPendingMembers()) {
            <div class="collapsible-content">
              @if (isLoadingMembers()) {
                <p class="loading-message">Loading members...</p>
              } @else {
                <div class="members-list">
                  @for (member of pendingMembers(); track member.userId) {
                    <div class="member-item pending">
                      <div class="member-info">
                        <div class="member-name">
                          {{ member.user?.fullName || 'Unknown User' }}
                        </div>
                        @if (member.user?.primaryEmail) {
                          <div class="member-email">{{ member.user?.primaryEmail }}</div>
                        }
                        @if (member.user?.primaryPhone) {
                          <div class="member-phone">{{ member.user?.primaryPhone }}</div>
                        }
                        <div class="member-roles">
                          <span class="role-tag">{{ member.roles.join(', ') }}</span>
                          @if (member.subteams && member.subteams.length > 0) {
                            @for (subteam of member.subteams; track subteam) {
                              <span class="subteam-tag">{{ subteam }}</span>
                            }
                          }
                          @if (member.leadPositions && member.leadPositions.length > 0) {
                            @for (leadPos of member.leadPositions; track $index) {
                              <span class="lead-position-tag">{{ leadPos.subteamName }} {{ leadPos.positionTitle }}</span>
                            }
                          }
                        </div>
                      </div>
                      <div class="member-actions">
                        <button 
                          class="approve-button"
                          (click)="approveMember(member.userId)">
                          Approve
                        </button>
                        <button 
                          class="reject-button"
                          (click)="rejectMember(member.userId)">
                          Reject
                        </button>
                      </div>
                    </div>
                  }
                </div>
              }
            </div>
          }
        </div>
      }

      <div class="members-card">
        <button 
          class="collapsible-header" 
          (click)="toggleActiveMembers()"
          [class.active]="showActiveMembers()">
          <span class="chevron">{{ showActiveMembers() ? '‚ñº' : '‚ñ∂' }}</span>
          <h2>Team Members ({{ activeMembers().length }})</h2>
        </button>

        @if (showActiveMembers()) {
          <div class="collapsible-content">
            <div class="member-filter-container">
              <input 
                type="text"
                class="member-filter-input"
                placeholder="Filter by name or email..."
                [(ngModel)]="memberFilter"
                [disabled]="isLoadingMembers()"
              />
              @if (memberFilter()) {
                <button 
                  class="clear-filter-button"
                  (click)="memberFilter.set('')"
                  title="Clear filter">
                  √ó
                </button>
              }
            </div>
            
            @if (isLoadingMembers()) {
              <p class="loading-message">Loading members...</p>
            } @else if (filteredActiveMembers().length === 0 && memberFilter()) {
              <p class="empty-message">No members match "{{ memberFilter() }}"</p>
            } @else if (activeMembers().length === 0) {
              <p class="empty-message">No active members.</p>
            } @else {
              <div class="members-list">
                @for (member of filteredActiveMembers(); track member.userId) {
                  <div class="member-item active" [class.disabled]="member.user?.isActive === false">
                    <div class="member-info">
                      <div class="member-name">
                        {{ member.user?.fullName || 'Unknown User' }}
                        @if (member.user?.isActive === false) {
                          <span class="disabled-badge">Disabled</span>
                        }
                      </div>
                      @if (member.user?.primaryEmail) {
                        <div class="member-email">{{ member.user?.primaryEmail }}</div>
                      }
                      @if (member.user?.primaryPhone) {
                        <div class="member-phone">{{ member.user?.primaryPhone }}</div>
                      }
                      
                      <div class="member-roles">
                        @for (role of member.roles; track role) {
                          <span class="role-tag">{{ role }}</span>
                        }
                        @if (member.subteams && member.subteams.length > 0) {
                          @for (subteam of member.subteams; track subteam) {
                            <span class="subteam-tag">{{ subteam }}</span>
                          }
                        }
                        @if (member.leadPositions && member.leadPositions.length > 0) {
                          @for (leadPos of member.leadPositions; track $index) {
                            <span class="lead-position-tag">{{ leadPos.subteamName }} {{ leadPos.positionTitle }}</span>
                          }
                        }
                      </div>
                    </div>
                    <div class="member-status">
                      <span class="status-badge active">Active</span>
                      @if (isTeamAdmin()) {
                        <button 
                          class="edit-member-button"
                          (click)="openEditMemberDialog(member)">
                          Edit
                        </button>
                      }
                    </div>
                  </div>
                }
              </div>
            }
          </div>
        }
      </div>

      <!-- Subteams Section -->
      <div class="members-card">
        <div class="subteams-header-wrapper">
          <button class="collapsible-header" (click)="toggleSubteamsSection()" [class.active]="showSubteamsSection()">
            <span class="chevron">{{ showSubteamsSection() ? '‚ñº' : '‚ñ∂' }}</span>
            <h2>Subteams ({{ subteams().length }})</h2>
          </button>
          @if (isTeamAdmin()) {
            <button (click)="openCreateSubteamDialog()" class="create-subteam-button">
              <span class="plus-icon">+</span> Create Subteam
            </button>
          }
        </div>

        @if (showSubteamsSection()) {
          <div class="collapsible-content">
            @if (isLoadingSubteams()) {
              <p class="loading-message">Loading subteams...</p>
            } @else if (subteams().length === 0) {
              <p class="empty-message">No subteams created yet.@if (isTeamAdmin()) { Click "Create Subteam" to get started.}</p>
            } @else {
              <div class="subteams-grid">
                @for (subteam of subteams(); track subteam.id) {
                  <div class="subteam-card" (click)="openSubteamDetailDialog(subteam)">
                    <div class="subteam-header">
                      <h3>{{ subteam.name }}</h3>
                      @if (isTeamAdmin()) {
                        <div class="subteam-actions" (click)="$event.stopPropagation()">
                          <button 
                            class="action-button edit"
                            (click)="openEditSubteamDialog(subteam)"
                            title="Edit">
                            ‚úé
                          </button>
                          <button 
                            class="action-button manage"
                            (click)="openManageMembersDialog(subteam)"
                            title="Manage Members">
                            üë•
                          </button>
                          <button 
                            class="action-button delete"
                            (click)="deleteSubteam(subteam)"
                            title="Delete">
                            üóë
                          </button>
                        </div>
                      }
                    </div>

                    @if (subteam.description) {
                      <p class="subteam-description">{{ subteam.description }}</p>
                    }

                    <div class="subteam-info">
                      <div class="info-item">
                        <strong>Valid Roles:</strong>
                        <span class="valid-roles">
                          @if (subteam.validRoles.length === 0) {
                            <em>All roles</em>
                          } @else {
                            {{ subteam.validRoles.join(', ') }}
                          }
                        </span>
                      </div>

                      <div class="info-item">
                        <strong>Members:</strong>
                        <span class="member-count">{{ subteam.members.length }}</span>
                      </div>
                    </div>

                    @if (subteam.leadPositions.length > 0) {
                      <div class="lead-positions">
                        <strong>Lead Positions:</strong>
                        @for (position of subteam.leadPositions; track position.id) {
                          <div class="lead-position">
                            <span class="position-title">{{ position.title }}</span>
                            <span class="position-role">({{ position.requiredRole }})</span>:
                            @if (position.userId) {
                              <span class="assigned-user">{{ position.userName }}</span>
                            } @else {
                              <em class="unassigned">Unassigned</em>
                            }
                          </div>
                        }
                      </div>
                    }
                  </div>
                }
              </div>
            }
          </div>
        }
      </div>

      <!-- Calendar Section -->
      <div class="members-card">
        <div class="calendar-header-wrapper">
          <button class="collapsible-header" (click)="toggleCalendarSection()" [class.active]="showCalendarSection()">
            <span class="chevron">{{ showCalendarSection() ? '‚ñº' : '‚ñ∂' }}</span>
            <h2>Calendar</h2>
          </button>
        </div>

        @if (showCalendarSection()) {
          <div class="collapsible-content">
            <div class="calendar-wrapper">
              <app-calendar 
                [teamId]="team()!.id"
                [teamRoles]="teamRoles()"
                [isAdmin]="isTeamAdmin()"
                [members]="members()"
                [subteams]="subteams()">
              </app-calendar>
            </div>
          </div>
        }
      </div>
    </main>
  } @else {
    <div class="loading-container">
      <p class="loading-message">Loading team details...</p>
    </div>
  }
</div>

@if (showRoleEditor()) {
  <div class="dialog-overlay" (click)="closeRoleEditor()">
    <div class="dialog-content role-editor" (click)="$event.stopPropagation()">
      <div class="dialog-header">
        <h2>Edit Roles</h2>
        <button class="close-button" (click)="closeRoleEditor()">√ó</button>
      </div>

      <div class="role-editor-content">
        <p class="editor-description">
          Manage the available roles for this team. The Administrator role cannot be deleted.
        </p>

        <div class="current-roles">
          <h3>Current Roles</h3>
          <div class="roles-list">
            @for (role of editingRoles(); track role) {
              <div class="role-item" [class.protected]="role === 'Administrator'">
                <span class="role-name">{{ role }}</span>
                @if (role === 'Administrator') {
                  <span class="protected-badge">Protected</span>
                } @else {
                  <button 
                    class="remove-role-button"
                    (click)="removeRoleFromEditor(role)"
                    [disabled]="isSavingRoles()">
                    Remove
                  </button>
                }
              </div>
            }
          </div>
        </div>

        <div class="add-role-section">
          <h3>Add New Role</h3>
          <div class="add-role-form">
            <input 
              type="text"
              [(ngModel)]="newRoleName"
              placeholder="Enter role name"
              [disabled]="isSavingRoles()"
              (keyup.enter)="addRoleToEditor()"
            />
            <button 
              class="add-role-button"
              (click)="addRoleToEditor()"
              [disabled]="!newRoleName().trim() || isSavingRoles()">
              Add Role
            </button>
          </div>
        </div>

        @if (roleEditorError()) {
          <div class="alert-error">
            {{ roleEditorError() }}
          </div>
        }

        <div class="dialog-actions">
          <button 
            class="cancel-button"
            (click)="closeRoleEditor()"
            [disabled]="isSavingRoles()">
            Cancel
          </button>
          <button 
            class="save-button"
            (click)="saveRoles()"
            [disabled]="isSavingRoles()">
            {{ isSavingRoles() ? 'Saving...' : 'Save Changes' }}
          </button>
        </div>
      </div>
    </div>
  </div>
}

@if (showDescriptionEditor()) {
  <div class="dialog-overlay" (click)="closeDescriptionEditor()">
    <div class="dialog-content description-editor" (click)="$event.stopPropagation()">
      <div class="dialog-header">
        <h2>Edit Team Description</h2>
        <button class="close-button" (click)="closeDescriptionEditor()">√ó</button>
      </div>

      <div class="description-editor-content">
        <p class="editor-description">
          Update the description and visibility for {{ team()?.name }}.
        </p>

        <div class="form-group">
          <label for="teamDescription">Description</label>
          <textarea 
            id="teamDescription"
            [(ngModel)]="editingDescription"
            rows="6"
            placeholder="Enter a description for your team"
            [disabled]="isSavingDescription()">
          </textarea>
        </div>

        <div class="form-group">
          <label for="teamVisibility">Team Visibility</label>
          <select 
            id="teamVisibility"
            [(ngModel)]="editingVisibility"
            [disabled]="isSavingDescription()">
            <option value="public">Public - Anyone can request to join</option>
            <option value="private">Private - Only invited members can join</option>
          </select>
        </div>

        @if (descriptionEditorError()) {
          <div class="alert-error">
            {{ descriptionEditorError() }}
          </div>
        }

        <div class="dialog-actions">
          <button 
            class="cancel-button"
            (click)="closeDescriptionEditor()"
            [disabled]="isSavingDescription()">
            Cancel
          </button>
          <button 
            class="save-button"
            (click)="saveDescription()"
            [disabled]="isSavingDescription()">
            {{ isSavingDescription() ? 'Saving...' : 'Save Changes' }}
          </button>
        </div>
      </div>
    </div>
  </div>
}

@if (showInviteDialog()) {
  <div class="dialog-overlay" (click)="closeInviteDialog()">
    <div class="dialog-content invite-dialog" (click)="$event.stopPropagation()">
      <div class="dialog-header">
        <h2>Invite Member to Team</h2>
        <button class="close-button" (click)="closeInviteDialog()">√ó</button>
      </div>

      <div class="invite-content">
        <p class="dialog-description">
          Enter the email address of the person you want to invite to join {{ team()?.name }}.
          They will receive an email invitation.
        </p>

        <div class="invite-form">
          <label for="inviteEmail">Email Address</label>
          <input 
            id="inviteEmail"
            type="email"
            [(ngModel)]="inviteEmail"
            placeholder="user@example.com"
            [disabled]="isSendingInvitation()"
            (keyup.enter)="sendInvitation()"
          />
          <button 
            class="send-button"
            (click)="sendInvitation()"
            [disabled]="!inviteEmail().trim() || isSendingInvitation()">
            {{ isSendingInvitation() ? 'Sending...' : 'Send Invitation' }}
          </button>
        </div>

        @if (invitationError()) {
          <div class="alert-error">
            {{ invitationError() }}
          </div>
        }

        <div class="invitations-list">
          <h3>Pending Invitations</h3>
          @if (teamInvitations().length === 0) {
            <p class="no-invitations">No pending invitations</p>
          } @else {
            <div class="invitations">
              @for (invitation of teamInvitations(); track invitation.id) {
                <div class="invitation-item" [class.status]="invitation.status">
                  <div class="invitation-email">{{ invitation.email }}</div>
                  <div class="invitation-status">{{ invitation.status }}</div>
                  <div class="invitation-date">{{ invitation.createdAt | date:'short' }}</div>
                </div>
              }
            </div>
          }
        </div>

        <div class="dialog-actions">
          <button 
            class="cancel-button"
            (click)="closeInviteDialog()">
            Close
          </button>
        </div>
      </div>
    </div>
  </div>
}

@if (showEditMemberDialog() && editingMember()) {
  <div class="dialog-overlay" (click)="closeEditMemberDialog()">
    <div class="dialog-content edit-member-dialog" (click)="$event.stopPropagation()">
      <div class="dialog-header">
        <h2>Edit Member: {{ editingMember()!.user?.fullName }}</h2>
        <button class="close-button" (click)="closeEditMemberDialog()">√ó</button>
      </div>

      <div class="edit-member-content">
        <div class="form-group">
          <label>Roles</label>
          <div class="roles-checkboxes">
            @for (role of teamRoles(); track role) {
              <label class="checkbox-label">
                <input 
                  type="checkbox"
                  [checked]="memberEditRoles().includes(role)"
                  (change)="toggleEditDialogRole(role)"
                  [disabled]="isSavingMemberAttributes()"
                />
                <span>{{ role }}</span>
              </label>
            }
          </div>
        </div>

        <div class="form-group">
          <label class="checkbox-label">
            <input 
              type="checkbox"
              [(ngModel)]="memberEditIsActive"
              [disabled]="isSavingMemberAttributes()"
            />
            <span>User Account Active</span>
          </label>
        </div>

        <div class="form-group">
          <label>Permissions</label>
          <div class="permissions-list">
            <div class="permission-item">
              <span>Send Messages</span>
              <label class="toggle-switch">
                <input 
                  type="checkbox"
                  [checked]="memberEditPermissions().get('SEND_MESSAGES')"
                  (change)="togglePermission('SEND_MESSAGES')"
                  [disabled]="isSavingMemberAttributes()"
                />
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div class="permission-item">
              <span>Schedule Events</span>
              <label class="toggle-switch">
                <input 
                  type="checkbox"
                  [checked]="memberEditPermissions().get('SCHEDULE_EVENTS')"
                  (change)="togglePermission('SCHEDULE_EVENTS')"
                  [disabled]="isSavingMemberAttributes()"
                />
                <span class="toggle-slider"></span>
              </label>
            </div>
          </div>
        </div>

        @if (memberEditError()) {
          <div class="alert-error">
            {{ memberEditError() }}
          </div>
        }

        <div class="dialog-actions">
          <button 
            class="cancel-button"
            (click)="closeEditMemberDialog()"
            [disabled]="isSavingMemberAttributes()">
            Cancel
          </button>
          <button 
            class="save-button"
            (click)="saveMemberAttributes()"
            [disabled]="isSavingMemberAttributes()">
            {{ isSavingMemberAttributes() ? 'Saving...' : 'Save Changes' }}
          </button>
        </div>
      </div>
    </div>
  </div>
}

@if (showConstraintsEditor()) {
  <div class="dialog-overlay" (click)="closeConstraintsEditor()">
    <div class="dialog-content constraints-editor" (click)="$event.stopPropagation()">
      <div class="dialog-header">
        <h2>
          Edit Role Constraints
          <span class="help-icon" title="This establishes pairs of team roles that a member cannot have at the same time.">‚ÑπÔ∏è</span>
        </h2>
        <button class="close-button" (click)="closeConstraintsEditor()">√ó</button>
      </div>

      <div class="constraints-editor-content">
        <p class="editor-description">
          Role constraints define pairs of roles that cannot be assigned to the same member simultaneously.
          For example, if you create a constraint between "Mentor" and "Student", a member cannot be both a Mentor and a Student at the same time.
        </p>

        <div class="current-constraints">
          <h3>Current Constraints</h3>
          @if (editingConstraints().length === 0) {
            <p class="no-constraints">No constraints defined. Members can have any combination of roles.</p>
          } @else {
            <div class="constraints-list">
              @for (constraint of editingConstraints(); track $index) {
                <div class="constraint-item">
                  <span class="constraint-pair">
                    <span class="role-name">{{ constraint[0] }}</span>
                    <span class="constraint-separator">‚Üî</span>
                    <span class="role-name">{{ constraint[1] }}</span>
                  </span>
                  <button 
                    class="remove-constraint-button"
                    (click)="removeConstraint($index)"
                    [disabled]="isSavingConstraints()">
                    Remove
                  </button>
                </div>
              }
            </div>
          }
        </div>

        <div class="add-constraint-section">
          <h3>Add New Constraint</h3>
          <div class="add-constraint-form">
            <div class="form-group">
              <label for="constraintRole1">First Role</label>
              <select 
                id="constraintRole1"
                [(ngModel)]="constraintRole1"
                [disabled]="isSavingConstraints()">
                <option value="">Select a role</option>
                @for (role of availableRoles(); track role) {
                  <option [value]="role">{{ role }}</option>
                }
              </select>
            </div>
            <div class="constraint-arrow">‚Üî</div>
            <div class="form-group">
              <label for="constraintRole2">Second Role</label>
              <select 
                id="constraintRole2"
                [(ngModel)]="constraintRole2"
                [disabled]="isSavingConstraints()">
                <option value="">Select a role</option>
                @for (role of availableRoles(); track role) {
                  <option [value]="role">{{ role }}</option>
                }
              </select>
            </div>
            <button 
              class="add-constraint-button"
              (click)="addConstraint()"
              [disabled]="!constraintRole1() || !constraintRole2() || isSavingConstraints()">
              Add Constraint
            </button>
          </div>
        </div>

        @if (constraintsEditorError()) {
          <div class="alert-error">
            {{ constraintsEditorError() }}
          </div>
        }

        <div class="dialog-actions">
          <button 
            class="cancel-button"
            (click)="closeConstraintsEditor()"
            [disabled]="isSavingConstraints()">
            Cancel
          </button>
          <button 
            class="save-button"
            (click)="saveConstraints()"
            [disabled]="isSavingConstraints()">
            {{ isSavingConstraints() ? 'Saving...' : 'Save Changes' }}
          </button>
        </div>
      </div>
    </div>
  </div>
}

@if (showImportDialog()) {
  <div class="dialog-overlay" (click)="closeImportDialog()">
    <div class="dialog-content import-roster-dialog" (click)="$event.stopPropagation()">
      <div class="dialog-header">
        <h2>Import Team Roster</h2>
        <button class="close-button" (click)="closeImportDialog()">√ó</button>
      </div>

      <div class="import-content">
        <p class="dialog-description">
          Upload a CSV file with team members. Required columns: <strong>First</strong>, <strong>Last</strong>, <strong>Email</strong>.<br>
          Optional columns: Address, City, State, Zip, Phone Number<br>
          <small>For multiple phone numbers, separate them with semicolons (e.g., "555-1234;555-5678")</small>
        </p>

        <div class="member-status-selector">
          <label>New user account status:</label>
          <div class="status-options">
            <label class="radio-option">
              <input 
                type="radio" 
                name="importStatus" 
                value="pending"
                [checked]="importStatus() === 'pending'"
                (change)="importStatus.set('pending')"
                [disabled]="isImporting()"
              />
              <span>Pending (requires email verification to login)</span>
            </label>
            <label class="radio-option">
              <input 
                type="radio" 
                name="importStatus" 
                value="active"
                [checked]="importStatus() === 'active'"
                (change)="importStatus.set('active')"
                [disabled]="isImporting()"
              />
              <span>Active (can login immediately)</span>
            </label>
          </div>
        </div>

        <div class="default-password-field">
          <label for="defaultPassword">Default Password (optional):</label>
          <input 
            type="text" 
            id="defaultPassword" 
            [value]="importDefaultPassword()"
            (input)="importDefaultPassword.set($any($event.target).value)"
            [disabled]="isImporting()"
            placeholder="Leave empty for random passwords"
            class="password-input"
          />
          <p class="field-hint">If provided, all new users will be created with this password. Leave empty to generate random passwords.</p>
        </div>

        <div 
          class="file-upload-area"
          [class.dragging]="isDragging()"
          (dragover)="onDragOver($event)"
          (dragleave)="onDragLeave($event)"
          (drop)="onDrop($event)">
          <div class="upload-icon">üìÅ</div>
          <p class="upload-text">Drag and drop CSV file here</p>
          <p class="upload-or">or</p>
          <input 
            type="file" 
            id="rosterFile" 
            accept=".csv"
            (change)="onFileSelected($event)"
            [disabled]="isImporting()"
            hidden
          />
          <label for="rosterFile" class="browse-button">
            Browse Files
          </label>
          @if (importFile()) {
            <div class="selected-file">
              <span class="file-name">üìÑ {{ importFile()?.name }}</span>
              <button 
                class="remove-file-button"
                (click)="importFile.set(null); $event.stopPropagation()"
                [disabled]="isImporting()">
                √ó
              </button>
            </div>
          }
        </div>

        @if (isImporting()) {
          <div class="progress-container">
            <div class="progress-header">
              <span class="progress-label">Importing roster...</span>
              <span class="progress-percentage">{{ importProgress().toFixed(0) }}%</span>
            </div>
            <div class="progress-bar">
              <div 
                class="progress-fill" 
                [style.width.%]="importProgress()">
              </div>
            </div>
            @if (importTotal() > 0) {
              <div class="progress-details">
                Processing {{ importTotal() }} members
              </div>
            }
          </div>
        }

        @if (importError()) {
          <div class="alert-error">
            {{ importError() }}
          </div>
        }

        @if (importResult()) {
          <div class="import-results">
            <h3>Import Results</h3>
            <div class="results-summary">
              <div class="result-stat success">
                <span class="stat-label">Successful:</span>
                <span class="stat-value">{{ importResult().successful }}</span>
              </div>
              <div class="result-stat error">
                <span class="stat-label">Failed:</span>
                <span class="stat-value">{{ importResult().failed }}</span>
              </div>
            </div>

            @if (importResult().created.length > 0) {
              <div class="result-section">
                <h4>New Users Created ({{ importResult().created.length }})</h4>
                <div class="result-list">
                  @for (user of importResult().created; track user.email) {
                    <div class="result-item">{{ user.name }} ({{ user.email }})</div>
                  }
                </div>
              </div>
            }

            @if (importResult().existing.length > 0) {
              <div class="result-section">
                <h4>Existing Users Added to Team ({{ importResult().existing.length }})</h4>
                <div class="result-list">
                  @for (user of importResult().existing; track user.email) {
                    <div class="result-item">{{ user.name }} ({{ user.email }})</div>
                  }
                </div>
              </div>
            }

            @if (importResult().errors.length > 0) {
              <div class="result-section errors">
                <h4>Errors ({{ importResult().errors.length }})</h4>
                <div class="result-list">
                  @for (error of importResult().errors; track error.row) {
                    <div class="result-item error">
                      Row {{ error.row }}: {{ error.error }}
                      @if (error.email) {
                        <span class="error-email">({{ error.email }})</span>
                      }
                    </div>
                  }
                </div>
              </div>
            }
          </div>
        }

        <div class="dialog-actions">
          <button 
            class="cancel-button"
            (click)="closeImportDialog()"
            [disabled]="isImporting()">
            {{ importResult() ? 'Close' : 'Cancel' }}
          </button>
          @if (!importResult()) {
            <button 
              class="import-button"
              (click)="importRoster()"
              [disabled]="!importFile() || isImporting()">
              {{ isImporting() ? 'Importing...' : 'Import Roster' }}
            </button>
          }
        </div>
      </div>
    </div>
  </div>
}

<!-- Create Subteam Dialog -->
@if (showCreateSubteamDialog()) {
  <div class="dialog-overlay" (click)="closeCreateSubteamDialog()">
    <div class="dialog-content subteam-dialog" (click)="$event.stopPropagation()">
      <div class="dialog-header">
        <h2>Create Subteam</h2>
        <button class="close-button" (click)="closeCreateSubteamDialog()">√ó</button>
      </div>

      <div class="subteam-form-content">
        <div class="form-group">
          <label for="subteamName">Subteam Name *</label>
          <input 
            id="subteamName"
            type="text"
            [(ngModel)]="subteamName"
            placeholder="Enter subteam name"
            [disabled]="isSavingSubteam()"
          />
        </div>

        <div class="form-group">
          <label for="subteamDescription">Description</label>
          <textarea 
            id="subteamDescription"
            [(ngModel)]="subteamDescription"
            placeholder="Optional description"
            rows="3"
            [disabled]="isSavingSubteam()">
          </textarea>
        </div>

        <div class="form-group">
          <label for="validRolesSelect">Valid Roles</label>
          <p class="field-help">Select which roles can be members of this subteam (leave empty for all roles)</p>
          <select 
            id="validRolesSelect"
            multiple
            [(ngModel)]="subteamValidRoles"
            [disabled]="isSavingSubteam()"
            class="role-multiselect"
            size="6">
            @for (role of teamRoles(); track role) {
              <option [value]="role">{{ role }}</option>
            }
          </select>
        </div>

        <div class="form-group">
          <label>Lead Positions</label>
          <p class="field-help">Define leadership positions for this subteam</p>
          
          <div class="lead-positions-list">
            @for (position of subteamLeadPositions(); track $index) {
              <div class="lead-position-item">
                <span class="position-info">
                  <strong>{{ position.title }}</strong> ({{ position.requiredRole }})
                </span>
                <button 
                  class="remove-button"
                  (click)="removeLeadPosition($index)"
                  [disabled]="isSavingSubteam()">
                  Remove
                </button>
              </div>
            }
            @if (subteamLeadPositions().length === 0) {
              <p class="no-positions">No lead positions defined</p>
            }
          </div>

          <div class="add-lead-position">
            <input 
              type="text"
              [(ngModel)]="newLeadTitle"
              placeholder="Position title"
              [disabled]="isSavingSubteam()"
            />
            <select 
              [(ngModel)]="newLeadRole"
              [disabled]="isSavingSubteam()">
              <option value="">Select required role</option>
              @for (role of teamRoles(); track role) {
                <option [value]="role">{{ role }}</option>
              }
            </select>
            <button 
              class="add-button"
              (click)="addLeadPosition()"
              [disabled]="!newLeadTitle().trim() || !newLeadRole() || isSavingSubteam()">
              Add Position
            </button>
          </div>
        </div>

        @if (subteamError()) {
          <div class="alert-error">
            {{ subteamError() }}
          </div>
        }

        <div class="dialog-actions">
          <button 
            class="cancel-button"
            (click)="closeCreateSubteamDialog()"
            [disabled]="isSavingSubteam()">
            Cancel
          </button>
          <button 
            class="save-button"
            (click)="createSubteam()"
            [disabled]="isSavingSubteam()">
            {{ isSavingSubteam() ? 'Creating...' : 'Create Subteam' }}
          </button>
        </div>
      </div>
    </div>
  </div>
}

<!-- Edit Subteam Dialog -->
@if (showEditSubteamDialog() && selectedSubteam()) {
  <div class="dialog-overlay" (click)="closeEditSubteamDialog()">
    <div class="dialog-content subteam-dialog" (click)="$event.stopPropagation()">
      <div class="dialog-header">
        <h2>Edit Subteam</h2>
        <button class="close-button" (click)="closeEditSubteamDialog()">√ó</button>
      </div>

      <div class="subteam-form-content">
        <div class="form-group">
          <label for="editSubteamName">Subteam Name *</label>
          <input 
            id="editSubteamName"
            type="text"
            [(ngModel)]="subteamName"
            placeholder="Enter subteam name"
            [disabled]="isSavingSubteam()"
          />
        </div>

        <div class="form-group">
          <label for="editSubteamDescription">Description</label>
          <textarea 
            id="editSubteamDescription"
            [(ngModel)]="subteamDescription"
            placeholder="Optional description"
            rows="3"
            [disabled]="isSavingSubteam()">
          </textarea>
        </div>

        <div class="form-group">
          <label for="editValidRolesSelect">Valid Roles</label>
          <p class="field-help">Select which roles can be members of this subteam</p>
          <select 
            id="editValidRolesSelect"
            multiple
            [(ngModel)]="subteamValidRoles"
            [disabled]="isSavingSubteam()"
            class="role-multiselect"
            size="6">
            @for (role of teamRoles(); track role) {
              <option [value]="role">{{ role }}</option>
            }
          </select>
        </div>

        <div class="form-group">
          <label>Lead Positions</label>
          <p class="field-help">Define and assign leadership positions</p>
          
          <div class="lead-positions-list">
            @for (position of selectedSubteam()!.leadPositions; track position.id) {
              <div class="lead-position-item edit-mode">
                <div class="position-header">
                  <span class="position-info">
                    <strong>{{ position.title }}</strong> ({{ position.requiredRole }})
                  </span>
                  <button 
                    class="remove-button"
                    (click)="removeExistingLeadPosition(selectedSubteam()!, position.id)"
                    [disabled]="isSavingSubteam()">
                    Remove
                  </button>
                </div>
                <div class="position-assignment">
                  <label>Assigned to:</label>
                  <select 
                    [value]="position.userId || ''"
                    (change)="assignLeadPosition(selectedSubteam()!, position.id, $any($event.target).value || null)"
                    [disabled]="isSavingSubteam()">
                    <option value="" [selected]="!position.userId">Unassigned</option>
                    @for (member of getEligibleLeads(selectedSubteam()!, position.requiredRole); track member.userId) {
                      <option [value]="member.userId" [selected]="position.userId === member.userId">{{ member.user?.fullName || member.user?.firstName }} ({{ member.user?.primaryEmail }})</option>
                    }
                  </select>
                </div>
              </div>
            }
            @for (position of subteamLeadPositions(); track $index) {
              <div class="lead-position-item edit-mode">
                <div class="position-header">
                  <span class="position-info">
                    <strong>{{ position.title }}</strong> ({{ position.requiredRole }}) <em class="new-tag">New</em>
                  </span>
                  <button 
                    class="remove-button"
                    (click)="removeLeadPosition($index)"
                    [disabled]="isSavingSubteam()">
                    Remove
                  </button>
                </div>
                <div class="position-assignment">
                  <label>Assigned to:</label>
                  <select disabled>
                    <option value="">Unassigned</option>
                  </select>
                </div>
              </div>
            }
            @if (selectedSubteam()!.leadPositions.length === 0 && subteamLeadPositions().length === 0) {
              <p class="no-positions">No lead positions defined</p>
            }
          </div>

          <div class="add-lead-position">
            <input 
              type="text"
              [(ngModel)]="newLeadTitle"
              placeholder="Position title"
              [disabled]="isSavingSubteam()"
            />
            <select 
              [(ngModel)]="newLeadRole"
              [disabled]="isSavingSubteam()">
              <option value="">Select required role</option>
              @for (role of teamRoles(); track role) {
                <option [value]="role">{{ role }}</option>
              }
            </select>
            <button 
              class="add-button"
              (click)="addLeadPosition()"
              [disabled]="!newLeadTitle().trim() || !newLeadRole() || isSavingSubteam()">
              Add Position
            </button>
          </div>
        </div>

        @if (subteamError()) {
          <div class="alert-error">
            {{ subteamError() }}
          </div>
        }

        <div class="dialog-actions">
          <button 
            class="cancel-button"
            (click)="closeEditSubteamDialog()"
            [disabled]="isSavingSubteam()">
            Cancel
          </button>
          <button 
            class="save-button"
            (click)="updateSubteam()"
            [disabled]="isSavingSubteam()">
            {{ isSavingSubteam() ? 'Saving...' : 'Save Changes' }}
          </button>
        </div>
      </div>
    </div>
  </div>
}

<!-- Manage Members Dialog -->
@if (showManageMembersDialog() && selectedSubteam()) {
  <div class="dialog-overlay" (click)="closeManageMembersDialog()">
    <div class="dialog-content manage-members-dialog" (click)="$event.stopPropagation()">
      <div class="dialog-header">
        <h2>Manage Members: {{ selectedSubteam()?.name }}</h2>
        <button class="close-button" (click)="closeManageMembersDialog()">√ó</button>
      </div>

      <div class="manage-members-content">
        <!-- Current Members -->
        <div class="current-members-section">
          <h3>Current Members ({{ selectedSubteam()!.members.length }})</h3>
          @if (selectedSubteam()!.members.length === 0) {
            <p class="no-members">No members in this subteam yet</p>
          } @else {
            <div class="members-list">
              @for (member of selectedSubteam()?.members; track member.id) {
                <div class="member-item">
                  <div class="member-info">
                    <span class="member-name">{{ member.userName }}</span>
                    <span class="member-email">{{ member.userEmail }}</span>
                  </div>
                  <button 
                    class="remove-member-button"
                    (click)="removeMember(selectedSubteam()!, member.userId)"
                    [disabled]="isUpdatingMembers()">
                    Remove
                  </button>
                </div>
              }
            </div>
          }
        </div>

        <!-- Add Members -->
        <div class="add-members-section">
          <h3>Add Members</h3>
          <p class="section-help">Select members from your team to add to this subteam</p>
          
          <!-- Role Filter Dropdown -->
          <div class="role-filter">
            <label for="roleFilter">Filter by Role:</label>
            <select 
              id="roleFilter"
              [(ngModel)]="memberRoleFilter"
              [disabled]="isUpdatingMembers()">
              <option value="">All Roles</option>
              @for (role of teamRoles(); track role) {
                <option [value]="role">{{ role }}</option>
              }
            </select>
          </div>
          
          @if (availableTeamMembers().length === 0) {
            <p class="no-available">
              @if (memberRoleFilter()) {
                No members with role "{{ memberRoleFilter() }}" available to add
              } @else {
                All team members are already in this subteam
              }
            </p>
          } @else {
            <div class="available-members-list">
              @for (member of availableTeamMembers(); track member.userId) {
                <label class="member-checkbox">
                  <input 
                    type="checkbox"
                    [checked]="selectedMemberIds().has(member.userId)"
                    (change)="toggleMemberSelection(member.userId)"
                    [disabled]="isUpdatingMembers()"
                  />
                  <div class="member-info">
                    <span class="member-name">{{ member.user?.fullName || member.user?.firstName }}</span>
                    <span class="member-email">{{ member.user?.primaryEmail }}</span>
                    <span class="member-roles">{{ member.roles.join(', ') }}</span>
                  </div>
                </label>
              }
            </div>

            <button 
              class="add-selected-button"
              (click)="addSelectedMembers()"
              [disabled]="selectedMemberIds().size === 0 || isUpdatingMembers()">
              {{ isUpdatingMembers() ? 'Adding...' : `Add Selected (${selectedMemberIds().size})` }}
            </button>
          }
        </div>

        <div class="dialog-actions">
          <button 
            class="close-button-action"
            (click)="closeManageMembersDialog()"
            [disabled]="isUpdatingMembers()">
            Close
          </button>
        </div>
      </div>
    </div>
  </div>
}

<!-- Subteam Detail Dialog -->
@if (showSubteamDetailDialog() && selectedSubteamForDetail()) {
  <div class="dialog-overlay" (click)="closeSubteamDetailDialog()">
    <div class="dialog-content subteam-detail-dialog" (click)="$event.stopPropagation()">
      <div class="dialog-header">
        <h2>{{ selectedSubteamForDetail()!.name }}</h2>
        <button class="close-button" (click)="closeSubteamDetailDialog()">√ó</button>
      </div>

      <div class="dialog-body">
        <!-- Description -->
        @if (selectedSubteamForDetail()!.description) {
          <div class="detail-section">
            <h3>Description</h3>
            <p class="subteam-description-text">{{ selectedSubteamForDetail()!.description }}</p>
          </div>
        }

        <!-- Valid Roles -->
        <div class="detail-section">
          <h3>Valid Roles</h3>
          <div class="roles-list">
            @for (role of selectedSubteamForDetail()!.validRoles; track role) {
              <span class="role-badge">{{ role }}</span>
            }
          </div>
        </div>

        <!-- Lead Positions -->
        @if (selectedSubteamForDetail()!.leadPositions.length > 0) {
          <div class="detail-section">
            <h3>Lead Positions</h3>
            <div class="leads-list">
              @for (position of selectedSubteamForDetail()!.leadPositions; track position.id) {
                <div class="lead-item">
                  <span class="lead-title">{{ position.title }}</span>
                  <span class="lead-name">
                    {{ position.userName || 'Unassigned' }}
                  </span>
                  <span class="lead-role">{{ position.requiredRole }}</span>
                </div>
              }
            </div>
          </div>
        }

        <!-- Members Grouped by Role -->
        <div class="detail-section">
          <h3>Members ({{ selectedSubteamForDetail()!.members.length }})</h3>
          @if (selectedSubteamForDetail()!.members.length === 0) {
            <p class="no-members">No members in this subteam</p>
          } @else {
            <div class="members-by-role">
              @for (roleGroup of Object.keys(subteamMembersGroupedByRole()); track roleGroup) {
                <div class="role-group">
                  <h4 class="role-group-title">{{ roleGroup }}</h4>
                  <div class="role-members-list">
                    @for (member of subteamMembersGroupedByRole()[roleGroup]; track member.userId) {
                      <div class="member-item-detail">
                        <span class="member-name">{{ member.userName }}</span>
                        <span class="member-email">{{ member.userEmail }}</span>
                      </div>
                    }
                  </div>
                </div>
              }
            </div>
          }
        </div>
      </div>

      <div class="dialog-actions">
        <button class="close-button-action" (click)="closeSubteamDetailDialog()">Close</button>
      </div>
    </div>
  </div>
}
