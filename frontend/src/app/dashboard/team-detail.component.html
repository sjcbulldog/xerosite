<div class="team-detail-container">
  <header class="team-detail-header">
    <button (click)="goBack()" class="back-button">← Back to Dashboard</button>
  </header>

  @if (team()) {
    <main class="team-detail-content">
      <div class="team-info-card">
        <div class="team-info-header">
          <div>
            <h1>{{ team()?.name }}</h1>
            <p class="team-number">Team #{{ team()?.teamNumber }}</p>
          </div>
          <div class="header-actions">
            @if (isTeamAdmin()) {
              <button (click)="openRoleEditor()" class="edit-roles-button">
                Edit Team Roles
              </button>
              <button (click)="openInviteDialog()" class="invite-button">
                Invite Member
              </button>
            }
            <span class="visibility-badge {{ team()?.visibility }}">
              {{ team()?.visibility | titlecase }}
            </span>
          </div>
        </div>
        
        @if (team()?.description) {
          <p class="team-description">{{ team()?.description }}</p>
        }

        <div class="team-stats">
          <div class="stat">
            <span class="stat-label">Active Members</span>
            <span class="stat-value">{{ activeMembers().length }}</span>
          </div>
          <div class="stat">
            <span class="stat-label">Pending Requests</span>
            <span class="stat-value pending">{{ pendingMembers().length }}</span>
          </div>
        </div>
      </div>

      @if (pendingMembers().length > 0) {
        <div class="members-card">
          <button 
            class="collapsible-header" 
            (click)="togglePendingMembers()"
            [class.active]="showPendingMembers()">
            <span class="chevron">{{ showPendingMembers() ? '▼' : '▶' }}</span>
            <h2>Pending Membership Requests ({{ pendingMembers().length }})</h2>
          </button>

          @if (showPendingMembers()) {
            <div class="collapsible-content">
              @if (isLoadingMembers()) {
                <p class="loading-message">Loading members...</p>
              } @else {
                <div class="members-list">
                  @for (member of pendingMembers(); track member.userId) {
                    <div class="member-item pending">
                      <div class="member-info">
                        <div class="member-name">
                          {{ member.user?.fullName || 'Unknown User' }}
                        </div>
                        @if (member.user?.primaryEmail) {
                          <div class="member-email">{{ member.user?.primaryEmail }}</div>
                        }
                        @if (member.user?.primaryPhone) {
                          <div class="member-phone">{{ member.user?.primaryPhone }}</div>
                        }
                        <div class="member-roles">
                          <span class="role-tag">{{ member.roles.join(', ') }}</span>
                        </div>
                      </div>
                      <div class="member-actions">
                        <button 
                          class="approve-button"
                          (click)="approveMember(member.userId)">
                          Approve
                        </button>
                        <button 
                          class="reject-button"
                          (click)="rejectMember(member.userId)">
                          Reject
                        </button>
                      </div>
                    </div>
                  }
                </div>
              }
            </div>
          }
        </div>
      }

      <div class="members-card">
        <button 
          class="collapsible-header" 
          (click)="toggleActiveMembers()"
          [class.active]="showActiveMembers()">
          <span class="chevron">{{ showActiveMembers() ? '▼' : '▶' }}</span>
          <h2>Team Members ({{ activeMembers().length }})</h2>
        </button>

        @if (showActiveMembers()) {
          <div class="collapsible-content">
            @if (isLoadingMembers()) {
              <p class="loading-message">Loading members...</p>
            } @else if (activeMembers().length === 0) {
              <p class="empty-message">No active members.</p>
            } @else {
              <div class="members-list">
                @for (member of activeMembers(); track member.userId) {
                  <div class="member-item active" [class.disabled]="member.user?.isActive === false">
                    <div class="member-info">
                      <div class="member-name">
                        {{ member.user?.fullName || 'Unknown User' }}
                        @if (member.user?.isActive === false) {
                          <span class="disabled-badge">Disabled</span>
                        }
                      </div>
                      @if (member.user?.primaryEmail) {
                        <div class="member-email">{{ member.user?.primaryEmail }}</div>
                      }
                      @if (member.user?.primaryPhone) {
                        <div class="member-phone">{{ member.user?.primaryPhone }}</div>
                      }
                      
                      @if (isTeamAdmin()) {
                        <div class="member-roles-edit">
                          <label>Roles:</label>
                          <div class="roles-checkboxes">
                            @for (role of availableRoles(); track role) {
                              <label class="role-checkbox">
                                <input 
                                  type="checkbox"
                                  [checked]="memberHasRole(member, role)"
                                  (change)="toggleMemberRole(member.userId, role, $event)"
                                  [disabled]="isUpdatingMemberRoles()"
                                />
                                <span>{{ role }}</span>
                              </label>
                            }
                          </div>
                        </div>
                      } @else {
                        <div class="member-roles">
                          @for (role of member.roles; track role) {
                            <span class="role-tag">{{ role }}</span>
                          }
                        </div>
                      }
                    </div>
                    <div class="member-status">
                      <span class="status-badge active">Active</span>
                      @if (isTeamAdmin()) {
                        <button 
                          class="toggle-active-button"
                          [class.enable]="member.user?.isActive === false"
                          [class.disable]="member.user?.isActive !== false"
                          (click)="toggleUserActiveStatus(member.userId, member.user?.isActive !== false)">
                          {{ member.user?.isActive === false ? 'Enable' : 'Disable' }}
                        </button>
                      }
                    </div>
                  </div>
                }
              </div>
            }
          </div>
        }
      </div>
    </main>
  } @else {
    <div class="loading-container">
      <p class="loading-message">Loading team details...</p>
    </div>
  }
</div>

@if (showRoleEditor()) {
  <div class="dialog-overlay" (click)="closeRoleEditor()">
    <div class="dialog-content role-editor" (click)="$event.stopPropagation()">
      <div class="dialog-header">
        <h2>Edit Team Roles</h2>
        <button class="close-button" (click)="closeRoleEditor()">×</button>
      </div>

      <div class="role-editor-content">
        <p class="editor-description">
          Manage the available roles for this team. The Administrator role cannot be deleted.
        </p>

        <div class="current-roles">
          <h3>Current Roles</h3>
          <div class="roles-list">
            @for (role of editingRoles(); track role) {
              <div class="role-item" [class.protected]="role === 'Administrator'">
                <span class="role-name">{{ role }}</span>
                @if (role === 'Administrator') {
                  <span class="protected-badge">Protected</span>
                } @else {
                  <button 
                    class="remove-role-button"
                    (click)="removeRoleFromEditor(role)"
                    [disabled]="isSavingRoles()">
                    Remove
                  </button>
                }
              </div>
            }
          </div>
        </div>

        <div class="add-role-section">
          <h3>Add New Role</h3>
          <div class="add-role-form">
            <input 
              type="text"
              [(ngModel)]="newRoleName"
              placeholder="Enter role name"
              [disabled]="isSavingRoles()"
              (keyup.enter)="addRoleToEditor()"
            />
            <button 
              class="add-role-button"
              (click)="addRoleToEditor()"
              [disabled]="!newRoleName().trim() || isSavingRoles()">
              Add Role
            </button>
          </div>
        </div>

        @if (roleEditorError()) {
          <div class="alert-error">
            {{ roleEditorError() }}
          </div>
        }

        <div class="dialog-actions">
          <button 
            class="cancel-button"
            (click)="closeRoleEditor()"
            [disabled]="isSavingRoles()">
            Cancel
          </button>
          <button 
            class="save-button"
            (click)="saveRoles()"
            [disabled]="isSavingRoles()">
            {{ isSavingRoles() ? 'Saving...' : 'Save Changes' }}
          </button>
        </div>
      </div>
    </div>
  </div>
}

@if (showInviteDialog()) {
  <div class="dialog-overlay" (click)="closeInviteDialog()">
    <div class="dialog-content invite-dialog" (click)="$event.stopPropagation()">
      <div class="dialog-header">
        <h2>Invite Member to Team</h2>
        <button class="close-button" (click)="closeInviteDialog()">×</button>
      </div>

      <div class="invite-content">
        <p class="dialog-description">
          Enter the email address of the person you want to invite to join {{ team()?.name }}.
          They will receive an email invitation.
        </p>

        <div class="invite-form">
          <label for="inviteEmail">Email Address</label>
          <input 
            id="inviteEmail"
            type="email"
            [(ngModel)]="inviteEmail"
            placeholder="user@example.com"
            [disabled]="isSendingInvitation()"
            (keyup.enter)="sendInvitation()"
          />
          <button 
            class="send-button"
            (click)="sendInvitation()"
            [disabled]="!inviteEmail().trim() || isSendingInvitation()">
            {{ isSendingInvitation() ? 'Sending...' : 'Send Invitation' }}
          </button>
        </div>

        @if (invitationError()) {
          <div class="alert-error">
            {{ invitationError() }}
          </div>
        }

        <div class="invitations-list">
          <h3>Pending Invitations</h3>
          @if (teamInvitations().length === 0) {
            <p class="no-invitations">No pending invitations</p>
          } @else {
            <div class="invitations">
              @for (invitation of teamInvitations(); track invitation.id) {
                <div class="invitation-item" [class.status]="invitation.status">
                  <div class="invitation-email">{{ invitation.email }}</div>
                  <div class="invitation-status">{{ invitation.status }}</div>
                  <div class="invitation-date">{{ invitation.createdAt | date:'short' }}</div>
                </div>
              }
            </div>
          }
        </div>

        <div class="dialog-actions">
          <button 
            class="cancel-button"
            (click)="closeInviteDialog()">
            Close
          </button>
        </div>
      </div>
    </div>
  </div>
}
