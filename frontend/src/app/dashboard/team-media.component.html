<div class="team-media-card">
  <button 
    class="collapsible-header" 
    (click)="toggleSection()"
    [class.active]="showSection()">
    <span class="chevron">{{ showSection() ? '‚ñº' : '‚ñ∂' }}</span>
    <h2>Media ({{ teamMediaService.mediaFiles().length }})</h2>
  </button>
  <button (click)="openUploadDialog()" class="upload-button" title="Upload File">
    <span class="plus-icon">+</span>
  </button>

  @if (showSection()) {
    <div class="collapsible-content">
      <!-- Filter Input and Expand/Collapse Buttons -->
      <div class="filter-container">
        <div class="filter-input-wrapper">
          <input 
            type="text" 
            [value]="filterText()"
            (input)="filterText.set($any($event.target).value)"
            placeholder="Filter by title, filename, or uploader..."
            class="filter-input"
          />
          @if (filterText()) {
            <button (click)="filterText.set('')" class="clear-filter" title="Clear filter">
              √ó
            </button>
          }
        </div>
        <div class="filter-buttons">
          <button (click)="expandAll()" class="expand-collapse-button" title="Expand All">
            ‚§µ
          </button>
          <button (click)="collapseAll()" class="expand-collapse-button" title="Collapse All">
            ‚§¥
          </button>
        </div>
      </div>

      @if (teamMediaService.isLoading()) {
        <p class="loading-message">Loading media files...</p>
      } @else if (teamMediaService.error()) {
        <p class="error-message">{{ teamMediaService.error() }}</p>
      } @else if (filteredMedia().length === 0 && !filterText()) {
        <p class="empty-message">No media files uploaded yet.</p>
      } @else if (filteredMedia().length === 0 && filterText()) {
        <p class="empty-message">No media files match "{{ filterText() }}".</p>
      } @else {
        <!-- Year Sections -->
        @for (year of getYearsArray(); track year) {
          <div class="year-section">
            <button 
              class="year-header" 
              (click)="toggleYearSection(year)"
              [class.active]="isYearExpanded(year)">
              <span class="chevron">{{ isYearExpanded(year) ? '‚ñº' : '‚ñ∂' }}</span>
              <h3>{{ getYearLabel(year) }} ({{ (mediaByYear().get(year)?.get('pictures')?.length || 0) + (mediaByYear().get(year)?.get('videos')?.length || 0) + (mediaByYear().get(year)?.get('other')?.length || 0) }})</h3>
            </button>
            
            @if (isYearExpanded(year)) {
              <div class="year-content">
                <!-- Pictures Section -->
                @if (getMediaTypeCount(year, 'pictures') > 0) {
                  <div class="media-type-section">
                    <button 
                      class="media-type-header" 
                      (click)="toggleMediaTypeSection(year, 'pictures')"
                      [class.active]="isMediaTypeExpanded(year, 'pictures')">
                      <span class="chevron">{{ isMediaTypeExpanded(year, 'pictures') ? '‚ñº' : '‚ñ∂' }}</span>
                      <h4>{{ getMediaTypeLabel('pictures') }} ({{ getMediaTypeCount(year, 'pictures') }})</h4>
                    </button>
                    
                    @if (isMediaTypeExpanded(year, 'pictures')) {
                      <div class="media-list">
                        @for (media of getMediaForType(year, 'pictures'); track media.id) {
                          <div class="media-item">
                            @if (editingMedia()?.id === media.id) {
                              <div class="edit-form">
                                <input 
                                  type="text" 
                                  [value]="editTitle()"
                                  (input)="editTitle.set($any($event.target).value)"
                                  placeholder="Title"
                                  class="edit-input"
                                />
                                <input 
                                  type="number" 
                                  [value]="editYear()"
                                  (input)="editYear.set(+$any($event.target).value)"
                                  placeholder="Year"
                                  min="1900"
                                  max="2100"
                                  class="edit-input year-input"
                                />
                                <select
                                  [ngModel]="editUserGroupId() || ''"
                                  (ngModelChange)="editUserGroupId.set($event || null)"
                                  class="edit-input"
                                >
                                  <option value="">All Team Members</option>
                                  @for (group of userGroups(); track group.id) {
                                    <option [value]="group.id">{{ group.name }}</option>
                                  }
                                </select>
                                <div class="edit-actions">
                                  <button (click)="saveEdit()" class="save-button">Save</button>
                                  <button (click)="cancelEdit()" class="cancel-button">Cancel</button>
                                </div>
                              </div>
                            } @else {
                              <div class="media-content">
                                <div class="media-info">
                                  <div 
                                    class="media-thumbnail" 
                                    (click)="openPreview(media)"
                                    [class.clickable]="canPreview(media.mimeType)"
                                    title="Click to preview">
                                    @if (getPreviewUrl(media)) {
                                      <img 
                                        [src]="getPreviewUrl(media)" 
                                        [alt]="media.title"
                                        class="thumbnail-image"
                                      />
                                    } @else {
                                      <div class="thumbnail-loading">
                                        <span>üñºÔ∏è</span>
                                      </div>
                                    }
                                  </div>
                                  <div class="media-details">
                                    <div class="media-title">{{ media.title }}</div>
                                    <div class="media-meta">
                                      <span class="filename">{{ media.originalFilename }}</span>
                                      <span class="separator">‚Ä¢</span>
                                      <span class="filesize">{{ formatFileSize(media.fileSize) }}</span>
                                      <span class="separator">‚Ä¢</span>
                                      <span class="uploader">{{ media.uploaderName }}</span>
                                      <span class="separator">‚Ä¢</span>
                                      <span class="upload-date">{{ media.createdAt | date:'MMM d, y' }}</span>
                                      @if (media.userGroupName) {
                                        <span class="separator">‚Ä¢</span>
                                        <span class="user-group" title="Visible to: {{ media.userGroupName }}">üë• {{ media.userGroupName }}</span>
                                      }
                                    </div>
                                  </div>
                                </div>
                                <div class="media-actions">
                                  <button (click)="downloadMedia(media)" class="action-button download" title="Download">
                                    ‚¨áÔ∏è
                                  </button>
                                  @if (canEditOrDelete(media)) {
                                    <button (click)="startEdit(media)" class="action-button edit" title="Edit Title">
                                      ‚úèÔ∏è
                                    </button>
                                    <button (click)="deleteMedia(media)" class="action-button delete" title="Delete">
                                      üóëÔ∏è
                                    </button>
                                  }
                                </div>
                              </div>
                            }
                          </div>
                        }
                      </div>
                    }
                  </div>
                }

                <!-- Videos Section -->
                @if (getMediaTypeCount(year, 'videos') > 0) {
                  <div class="media-type-section">
                    <button 
                      class="media-type-header" 
                      (click)="toggleMediaTypeSection(year, 'videos')"
                      [class.active]="isMediaTypeExpanded(year, 'videos')">
                      <span class="chevron">{{ isMediaTypeExpanded(year, 'videos') ? '‚ñº' : '‚ñ∂' }}</span>
                      <h4>{{ getMediaTypeLabel('videos') }} ({{ getMediaTypeCount(year, 'videos') }})</h4>
                    </button>
                    
                    @if (isMediaTypeExpanded(year, 'videos')) {
                      <div class="media-list">
                        @for (media of getMediaForType(year, 'videos'); track media.id) {
                          <div class="media-item">
                            @if (editingMedia()?.id === media.id) {
                              <div class="edit-form">
                                <input 
                                  type="text" 
                                  [value]="editTitle()"
                                  (input)="editTitle.set($any($event.target).value)"
                                  placeholder="Title"
                                  class="edit-input"
                                />
                                <input 
                                  type="number" 
                                  [value]="editYear()"
                                  (input)="editYear.set(+$any($event.target).value)"
                                  placeholder="Year"
                                  min="1900"
                                  max="2100"
                                  class="edit-input year-input"
                                />
                                <select
                                  [ngModel]="editUserGroupId() || ''"
                                  (ngModelChange)="editUserGroupId.set($event || null)"
                                  class="edit-input"
                                >
                                  <option value="">All Team Members</option>
                                  @for (group of userGroups(); track group.id) {
                                    <option [value]="group.id">{{ group.name }}</option>
                                  }
                                </select>
                                <div class="edit-actions">
                                  <button (click)="saveEdit()" class="save-button">Save</button>
                                  <button (click)="cancelEdit()" class="cancel-button">Cancel</button>
                                </div>
                              </div>
                            } @else {
                              <div class="media-content">
                                <div class="media-info">
                                  <div 
                                    class="media-thumbnail" 
                                    (click)="openPreview(media)"
                                    [class.clickable]="canPreview(media.mimeType)"
                                    title="Click to preview">
                                    @if (thumbnailUrls().get(media.id)) {
                                      <img 
                                        [src]="thumbnailUrls().get(media.id)" 
                                        [alt]="media.title"
                                        class="thumbnail-video"
                                      />
                                      <div class="video-play-overlay">‚ñ∂</div>
                                    } @else {
                                      <div class="thumbnail-loading">
                                        <span>üé¨</span>
                                      </div>
                                    }
                                  </div>
                                  <div class="media-details">
                                    <div class="media-title">{{ media.title }}</div>
                                    <div class="media-meta">
                                      <span class="filename">{{ media.originalFilename }}</span>
                                      <span class="separator">‚Ä¢</span>
                                      <span class="filesize">{{ formatFileSize(media.fileSize) }}</span>
                                      <span class="separator">‚Ä¢</span>
                                      <span class="uploader">{{ media.uploaderName }}</span>
                                      <span class="separator">‚Ä¢</span>
                                      <span class="upload-date">{{ media.createdAt | date:'MMM d, y' }}</span>
                                      @if (media.userGroupName) {
                                        <span class="separator">‚Ä¢</span>
                                        <span class="user-group" title="Visible to: {{ media.userGroupName }}">üë• {{ media.userGroupName }}</span>
                                      }
                                    </div>
                                  </div>
                                </div>
                                <div class="media-actions">
                                  <button (click)="downloadMedia(media)" class="action-button download" title="Download">
                                    ‚¨áÔ∏è
                                  </button>
                                  @if (canEditOrDelete(media)) {
                                    <button (click)="startEdit(media)" class="action-button edit" title="Edit Title">
                                      ‚úèÔ∏è
                                    </button>
                                    <button (click)="deleteMedia(media)" class="action-button delete" title="Delete">
                                      üóëÔ∏è
                                    </button>
                                  }
                                </div>
                              </div>
                            }
                          </div>
                        }
                      </div>
                    }
                  </div>
                }

                <!-- Other Files Section -->
                @if (getMediaTypeCount(year, 'other') > 0) {
                  <div class="media-type-section">
                    <button 
                      class="media-type-header" 
                      (click)="toggleMediaTypeSection(year, 'other')"
                      [class.active]="isMediaTypeExpanded(year, 'other')">
                      <span class="chevron">{{ isMediaTypeExpanded(year, 'other') ? '‚ñº' : '‚ñ∂' }}</span>
                      <h4>{{ getMediaTypeLabel('other') }} ({{ getMediaTypeCount(year, 'other') }})</h4>
                    </button>
                    
                    @if (isMediaTypeExpanded(year, 'other')) {
                      <div class="media-list">
                        @for (media of getMediaForType(year, 'other'); track media.id) {
                          <div class="media-item">
                            @if (editingMedia()?.id === media.id) {
                              <div class="edit-form">
                                <input 
                                  type="text" 
                                  [value]="editTitle()"
                                  (input)="editTitle.set($any($event.target).value)"
                                  placeholder="Title"
                                  class="edit-input"
                                />
                                <input 
                                  type="number" 
                                  [value]="editYear()"
                                  (input)="editYear.set(+$any($event.target).value)"
                                  placeholder="Year"
                                  min="1900"
                                  max="2100"
                                  class="edit-input year-input"
                                />
                                <select
                                  [ngModel]="editUserGroupId() || ''"
                                  (ngModelChange)="editUserGroupId.set($event || null)"
                                  class="edit-input"
                                >
                                  <option value="">All Team Members</option>
                                  @for (group of userGroups(); track group.id) {
                                    <option [value]="group.id">{{ group.name }}</option>
                                  }
                                </select>
                                <div class="edit-actions">
                                  <button (click)="saveEdit()" class="save-button">Save</button>
                                  <button (click)="cancelEdit()" class="cancel-button">Cancel</button>
                                </div>
                              </div>
                            } @else {
                              <div class="media-content">
                                <div class="media-info">
                                  <span class="file-icon">{{ getFileIcon(media.mimeType) }}</span>
                                  <div class="media-details">
                                    <div class="media-title">{{ media.title }}</div>
                                    <div class="media-meta">
                                      <span class="filename">{{ media.originalFilename }}</span>
                                      <span class="separator">‚Ä¢</span>
                                      <span class="filesize">{{ formatFileSize(media.fileSize) }}</span>
                                      <span class="separator">‚Ä¢</span>
                                      <span class="uploader">{{ media.uploaderName }}</span>
                                      <span class="separator">‚Ä¢</span>
                                      <span class="upload-date">{{ media.createdAt | date:'MMM d, y' }}</span>
                                      @if (media.userGroupName) {
                                        <span class="separator">‚Ä¢</span>
                                        <span class="user-group" title="Visible to: {{ media.userGroupName }}">üë• {{ media.userGroupName }}</span>
                                      }
                                    </div>
                                  </div>
                                </div>
                                <div class="media-actions">
                                  <button (click)="downloadMedia(media)" class="action-button download" title="Download">
                                    ‚¨áÔ∏è
                                  </button>
                                  @if (canEditOrDelete(media)) {
                                    <button (click)="startEdit(media)" class="action-button edit" title="Edit Title">
                                      ‚úèÔ∏è
                                    </button>
                                    <button (click)="deleteMedia(media)" class="action-button delete" title="Delete">
                                      üóëÔ∏è
                                    </button>
                                  }
                                </div>
                              </div>
                            }
                          </div>
                        }
                      </div>
                    }
                  </div>
                }
              </div>
            }
          </div>
        }
      }
    </div>
  }
</div>

<!-- Upload Dialog -->
@if (showUploadDialog()) {
  <div class="dialog-overlay">
    <div class="dialog-content">
      <h3>Upload Media File</h3>
      
      <div class="form-group">
        <label for="media-title">Title</label>
        <input 
          id="media-title"
          type="text" 
          [value]="uploadTitle()"
          (input)="uploadTitle.set($any($event.target).value)"
          placeholder="Enter title for the file"
          class="form-input"
          required
        />
      </div>

      <div class="form-group">
        <label for="media-year">Year</label>
        <input 
          id="media-year"
          type="number" 
          [value]="uploadYear()"
          (input)="uploadYear.set(+$any($event.target).value)"
          placeholder="Enter year"
          min="1900"
          max="2100"
          class="form-input"
          required
        />
      </div>

      <div class="form-group">
        <label for="media-user-group">Visible To</label>
        <select
          id="media-user-group"
          [ngModel]="uploadUserGroupId() || ''"
          (ngModelChange)="uploadUserGroupId.set($event || null)"
          class="form-input"
        >
          <option value="">All Team Members</option>
          @for (group of userGroups(); track group.id) {
            <option [value]="group.id">{{ group.name }}</option>
          }
        </select>
      </div>

      <div class="form-group">
        <label>File</label>
        <div 
          class="drop-zone"
          [class.dragging]="isDragging()"
          (dragover)="onDragOver($event)"
          (dragleave)="onDragLeave($event)"
          (drop)="onDrop($event)">
          @if (selectedFile()) {
            <div class="selected-file">
              <span class="file-icon">{{ getFileIcon(selectedFile()!.type) }}</span>
              <div class="file-info">
                <div class="file-name">{{ selectedFile()!.name }}</div>
                <div class="file-size">{{ formatFileSize(selectedFile()!.size) }}</div>
              </div>
              <button (click)="selectedFile.set(null)" class="remove-file" type="button">
                √ó
              </button>
            </div>
          } @else {
            <div class="drop-zone-content">
              <div class="drop-icon">üìÅ</div>
              <p class="drop-text">Drag and drop a file here</p>
              <p class="drop-or">or</p>
              <label class="browse-button">
                Browse Files
                <input 
                  type="file" 
                  (change)="onFileSelected($event)"
                  class="file-input"
                  hidden
                />
              </label>
            </div>
          }
        </div>
      </div>

      @if (isUploading()) {
        <div class="upload-progress-container">
          <div class="upload-progress-bar">
            <div 
              class="upload-progress-fill" 
              [style.width.%]="uploadProgress()">
            </div>
          </div>
          <div class="upload-progress-text">
            {{ uploadProgress() }}%
          </div>
        </div>
      }

      <div class="dialog-actions">
        <button 
          type="button" 
          (click)="uploadFile()" 
          class="primary-button"
          [disabled]="isUploading() || !selectedFile() || !uploadTitle()">
          @if (isUploading()) {
            Uploading...
          } @else {
            Upload
          }
        </button>
        <button 
          type="button" 
          (click)="closeUploadDialog()" 
          class="secondary-button"
          [disabled]="isUploading()">
          Cancel
        </button>
      </div>
    </div>
  </div>
}

<!-- Preview Dialog -->
@if (showPreviewDialog() && previewingMedia()) {
  <div class="preview-overlay">
    <div class="preview-container">
      <button class="preview-close" (click)="closePreview()" title="Close">√ó</button>
      
      <div class="preview-content">
        @if (isImage(previewingMedia()!.mimeType)) {
          <img 
            [src]="getPreviewUrl(previewingMedia()!)" 
            [alt]="previewingMedia()!.title"
            class="preview-image"
          />
        } @else if (isVideo(previewingMedia()!.mimeType)) {
          <video 
            [src]="getVideoUrl(previewingMedia()!)"
            class="preview-video"
            controls
            autoplay
          ></video>
        }
      </div>
      
      <div class="preview-info">
        <h3>{{ previewingMedia()!.title }}</h3>
        <p class="preview-filename">{{ previewingMedia()!.originalFilename }}</p>
      </div>
    </div>
  </div>
}
