<div class="team-media-card">
  <button 
    class="collapsible-header" 
    (click)="toggleSection()"
    [class.active]="showSection()">
    <span class="chevron">{{ showSection() ? '‚ñº' : '‚ñ∂' }}</span>
    <h2>Media</h2>
  </button>
  <button (click)="openUploadDialog()" class="upload-button" title="Upload File">
    <span class="plus-icon">+</span>
  </button>

  @if (showSection()) {
    <div class="collapsible-content">
      <!-- Filter Input -->
      <div class="filter-container">
        <input 
          type="text" 
          [value]="filterText()"
          (input)="filterText.set($any($event.target).value)"
          placeholder="Filter by title, filename, or uploader..."
          class="filter-input"
        />
        @if (filterText()) {
          <button (click)="filterText.set('')" class="clear-filter" title="Clear filter">
            √ó
          </button>
        }
      </div>

      @if (teamMediaService.isLoading()) {
        <p class="loading-message">Loading media files...</p>
      } @else if (teamMediaService.error()) {
        <p class="error-message">{{ teamMediaService.error() }}</p>
      } @else if (filteredMedia().length === 0 && !filterText()) {
        <p class="empty-message">No media files uploaded yet.</p>
      } @else if (filteredMedia().length === 0 && filterText()) {
        <p class="empty-message">No media files match "{{ filterText() }}".</p>
      } @else {
        <div class="media-list">
          @for (media of filteredMedia(); track media.id) {
            <div class="media-item">
              @if (editingMedia()?.id === media.id) {
                <div class="edit-form">
                  <input 
                    type="text" 
                    [value]="editTitle()"
                    (input)="editTitle.set($any($event.target).value)"
                    placeholder="Title"
                    class="edit-input"
                  />
                  <div class="edit-actions">
                    <button (click)="saveEdit()" class="save-button">Save</button>
                    <button (click)="cancelEdit()" class="cancel-button">Cancel</button>
                  </div>
                </div>
              } @else {
                <div class="media-content">
                  <div class="media-info">
                    @if (isImage(media.mimeType) || isVideo(media.mimeType)) {
                      <div 
                        class="media-thumbnail" 
                        (click)="openPreview(media)"
                        [class.clickable]="canPreview(media.mimeType)"
                        title="Click to preview">
                        @if (getPreviewUrl(media)) {
                          <img 
                            [src]="getPreviewUrl(media)" 
                            [alt]="media.title"
                            class="thumbnail-image"
                          />
                          @if (isVideo(media.mimeType)) {
                            <div class="video-play-overlay">‚ñ∂Ô∏è</div>
                          }
                        } @else {
                          <div class="thumbnail-loading">
                            @if (isVideo(media.mimeType)) {
                              <span>üé•</span>
                            } @else {
                              <span>üñºÔ∏è</span>
                            }
                          </div>
                        }
                      </div>
                    } @else {
                      <span class="file-icon">{{ getFileIcon(media.mimeType) }}</span>
                    }
                    <div class="media-details">
                      <div class="media-title">{{ media.title }}</div>
                      <div class="media-meta">
                        <span class="filename">{{ media.originalFilename }}</span>
                        <span class="separator">‚Ä¢</span>
                        <span class="filesize">{{ formatFileSize(media.fileSize) }}</span>
                        <span class="separator">‚Ä¢</span>
                        <span class="uploader">{{ media.uploaderName }}</span>
                        <span class="separator">‚Ä¢</span>
                        <span class="upload-date">{{ media.createdAt | date:'MMM d, y' }}</span>
                      </div>
                    </div>
                  </div>
                  <div class="media-actions">
                    <button (click)="downloadMedia(media)" class="action-button download" title="Download">
                      ‚¨áÔ∏è
                    </button>
                    @if (canEditOrDelete(media)) {
                      <button (click)="startEdit(media)" class="action-button edit" title="Edit Title">
                        ‚úèÔ∏è
                      </button>
                      <button (click)="deleteMedia(media)" class="action-button delete" title="Delete">
                        üóëÔ∏è
                      </button>
                    }
                  </div>
                </div>
              }
            </div>
          }
        </div>
      }
    </div>
  }
</div>

<!-- Upload Dialog -->
@if (showUploadDialog()) {
  <div class="dialog-overlay" (click)="closeUploadDialog()">
    <div class="dialog-content" (click)="$event.stopPropagation()">
      <h3>Upload Media File</h3>
      
      <div class="form-group">
        <label for="media-title">Title</label>
        <input 
          id="media-title"
          type="text" 
          [value]="uploadTitle()"
          (input)="uploadTitle.set($any($event.target).value)"
          placeholder="Enter title for the file"
          class="form-input"
          required
        />
      </div>

      <div class="form-group">
        <label>File</label>
        <div 
          class="drop-zone"
          [class.dragging]="isDragging()"
          (dragover)="onDragOver($event)"
          (dragleave)="onDragLeave($event)"
          (drop)="onDrop($event)">
          @if (selectedFile()) {
            <div class="selected-file">
              <span class="file-icon">{{ getFileIcon(selectedFile()!.type) }}</span>
              <div class="file-info">
                <div class="file-name">{{ selectedFile()!.name }}</div>
                <div class="file-size">{{ formatFileSize(selectedFile()!.size) }}</div>
              </div>
              <button (click)="selectedFile.set(null)" class="remove-file" type="button">
                √ó
              </button>
            </div>
          } @else {
            <div class="drop-zone-content">
              <div class="drop-icon">üìÅ</div>
              <p class="drop-text">Drag and drop a file here</p>
              <p class="drop-or">or</p>
              <label class="browse-button">
                Browse Files
                <input 
                  type="file" 
                  (change)="onFileSelected($event)"
                  class="file-input"
                  hidden
                />
              </label>
            </div>
          }
        </div>
      </div>

      <div class="dialog-actions">
        <button 
          type="button" 
          (click)="uploadFile()" 
          class="primary-button"
          [disabled]="isUploading() || !selectedFile() || !uploadTitle()">
          @if (isUploading()) {
            Uploading...
          } @else {
            Upload
          }
        </button>
        <button 
          type="button" 
          (click)="closeUploadDialog()" 
          class="secondary-button"
          [disabled]="isUploading()">
          Cancel
        </button>
      </div>
    </div>
  </div>
}

<!-- Preview Dialog -->
@if (showPreviewDialog() && previewingMedia()) {
  <div class="preview-overlay" (click)="closePreview()">
    <div class="preview-container">
      <button class="preview-close" (click)="closePreview()" title="Close">√ó</button>
      
      <div class="preview-content" (click)="$event.stopPropagation()">
        @if (isImage(previewingMedia()!.mimeType)) {
          <img 
            [src]="getPreviewUrl(previewingMedia()!)" 
            [alt]="previewingMedia()!.title"
            class="preview-image"
          />
        } @else if (isVideo(previewingMedia()!.mimeType)) {
          <video 
            [src]="getVideoUrl(previewingMedia()!)"
            class="preview-video"
            controls
            autoplay
          ></video>
        }
      </div>
      
      <div class="preview-info">
        <h3>{{ previewingMedia()!.title }}</h3>
        <p class="preview-filename">{{ previewingMedia()!.originalFilename }}</p>
      </div>
    </div>
  </div>
}
