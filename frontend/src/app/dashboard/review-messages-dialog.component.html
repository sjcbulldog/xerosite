<div class="dialog-overlay">
  <div class="dialog-content large-dialog">
    <div class="dialog-header">
      <h2>Review Messages</h2>
      <button class="close-button" (click)="closeDialog()">√ó</button>
    </div>

    <div class="dialog-body">
      <!-- Search and Filter Section -->
      <form [formGroup]="searchForm" class="search-form">
        <div class="search-row">
          <div class="search-field">
            <label for="search">Search</label>
            <input 
              id="search"
              type="text" 
              formControlName="search"
              placeholder="Search by subject, content, sender, or group name..."
            />
          </div>
          <div class="date-field">
            <label for="startDate">From Date</label>
            <input 
              id="startDate"
              type="date" 
              formControlName="startDate"
            />
          </div>
          <div class="date-field">
            <label for="endDate">To Date</label>
            <input 
              id="endDate"
              type="date" 
              formControlName="endDate"
            />
          </div>
          <div class="search-actions">
            <button 
              type="button" 
              class="search-button"
              (click)="onSearch()"
              [disabled]="isLoading()">
              {{ isLoading() ? 'Searching...' : 'Search' }}
            </button>
            <button 
              type="button" 
              class="clear-button"
              (click)="clearFilters()"
              [disabled]="isLoading()">
              Clear
            </button>
          </div>
        </div>
      </form>

      @if (error()) {
        <div class="alert-error">
          {{ error() }}
        </div>
      }

      <!-- Results Section -->
      <div class="results-section">
        <div class="results-header">
          <h3>
            @if (isLoading()) {
              Loading messages...
            } @else {
              {{ sortedMessages().length }} message{{ sortedMessages().length === 1 ? '' : 's' }} found
            }
          </h3>
        </div>

        @if (isLoading()) {
          <div class="loading-container">
            <div class="loading-spinner"></div>
            <p>Loading messages...</p>
          </div>
        } @else if (sortedMessages().length === 0) {
          <div class="empty-state">
            @if (searchForm.value.search || searchForm.value.startDate || searchForm.value.endDate) {
              <p>No messages match your search criteria.</p>
              <button type="button" class="clear-button" (click)="clearFilters()">
                Clear filters to see all messages
              </button>
            } @else {
              <p>No messages have been sent or received yet.</p>
            }
          </div>
        } @else {
          <!-- Messages Table -->
          <div class="table-container">
            <table class="messages-table">
              <thead>
                <tr>
                  <th class="sortable" (click)="sortBy('createdAt')">
                    Date {{ getSortIcon('createdAt') }}
                  </th>
                  <th>Direction</th>
                  <th class="sortable" (click)="sortBy('subject')">
                    Subject {{ getSortIcon('subject') }}
                  </th>
                  <th class="sortable" (click)="sortBy('senderName')">
                    Sender {{ getSortIcon('senderName') }}
                  </th>
                  <th class="sortable" (click)="sortBy('recipientType')">
                    Recipients {{ getSortIcon('recipientType') }}
                  </th>
                  <th class="sortable" (click)="sortBy('recipientCount')">
                    Count {{ getSortIcon('recipientCount') }}
                  </th>
                  <th>Attachments</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                @for (message of sortedMessages(); track message.id) {
                  <tr class="message-row">
                    <td class="date-cell">
                      {{ message.createdAt | date:'short' }}
                    </td>
                    <td class="direction-cell">
                      <span class="direction-badge" [class.sent]="isSentByCurrentUser(message)" [class.received]="!isSentByCurrentUser(message)">
                        {{ getMessageDirection(message) }}
                      </span>
                    </td>
                    <td class="subject-cell">
                      <div class="subject-content">
                        <strong>{{ message.subject }}</strong>
                        <div class="content-preview">
                          {{ truncateText(message.content, 80) }}
                        </div>
                      </div>
                    </td>
                    <td class="sender-cell">
                      <div class="sender-info">
                        <div class="sender-name">{{ message.senderName }}</div>
                        <div class="sender-email">{{ message.senderEmail }}</div>
                      </div>
                    </td>
                    <td class="recipients-cell">
                      {{ getRecipientTypeDisplay(message) }}
                    </td>
                    <td class="count-cell">
                      {{ message.recipientCount }}
                    </td>
                    <td class="attachments-cell">
                      @if (hasAttachments(message)) {
                        <button 
                          type="button" 
                          class="attachments-button"
                          (click)="toggleAttachments(message)"
                          [class.expanded]="isMessageExpanded(message.id)">
                          <span class="attachment-icon">üìé</span>
                          <span class="attachment-count">{{ getAttachmentCount(message) }}</span>
                          @if (message.hasUnviewedAttachments) {
                            <span class="new-badge">NEW</span>
                          }
                          <span class="expand-icon">{{ isMessageExpanded(message.id) ? '‚ñº' : '‚ñ∂' }}</span>
                        </button>
                      } @else {
                        <span class="no-attachments">‚Äî</span>
                      }
                    </td>
                    <td class="status-cell">
                      <span class="status-badge" [class]="getStatusClass(message)">
                        {{ getStatusDisplay(message) }}
                      </span>
                      @if (message.sentAt) {
                        <div class="sent-time">
                          {{ message.sentAt | date:'short' }}
                        </div>
                      }
                      @if (message.errorMessage) {
                        <div class="error-message" [title]="message.errorMessage">
                          Error occurred
                        </div>
                      }
                    </td>
                    <td class="actions-cell">
                      <button 
                        type="button" 
                        class="view-button"
                        (click)="viewMessageDetails(message)"
                        title="View full message details">
                        üëÅÔ∏è View
                      </button>
                    </td>
                  </tr>
                  @if (isMessageExpanded(message.id) && hasAttachments(message)) {
                    <tr class="attachments-expanded-row">
                      <td colspan="9" class="attachments-expanded-cell">
                        <div class="attachments-list">
                          <h4>Attachments ({{ getAttachmentCount(message) }})</h4>
                          <div class="attachment-items">
                            @for (attachment of message.attachments; track attachment.fileId) {
                              <div class="attachment-item">
                                <div class="attachment-info">
                                  <span class="attachment-icon">üìé</span>
                                  <div class="attachment-details">
                                    <div class="attachment-name">{{ attachment.originalName }}</div>
                                    <div class="attachment-meta">
                                      {{ formatFileSize(attachment.size) }}
                                    </div>
                                  </div>
                                </div>
                                <button 
                                  type="button" 
                                  class="download-button"
                                  (click)="downloadAttachment(message, attachment.fileId)"
                                  title="Download attachment">
                                  ‚¨áÔ∏è Download
                                </button>
                              </div>
                            }
                          </div>
                        </div>
                      </td>
                    </tr>
                  }
                }
              </tbody>
            </table>
          </div>
        }
      </div>
    </div>

    <div class="dialog-actions">
      <button 
        type="button" 
        class="close-action-button"
        (click)="closeDialog()">
        Close
      </button>
    </div>
  </div>
</div>
