<div class="dashboard-container">
  <header class="dashboard-header">
    <h1>Welcome, {{ authService.currentUser()?.firstName || 'User' }}!</h1>
    <div class="user-menu-container">
      <button (click)="toggleUserMenu()" class="user-menu-button">
        <svg class="menu-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
        <span class="chevron-down">â–¼</span>
      </button>
      @if (showUserMenu()) {
        <div class="user-menu-dropdown">
          <button (click)="navigateToProfile()" class="menu-item">
            <span class="menu-icon">ðŸ‘¤</span>
            Edit Profile
          </button>
          <button (click)="openChangePasswordDialog()" class="menu-item">
            <span class="menu-icon">ðŸ”’</span>
            Change Password
          </button>
          <button (click)="logout()" class="menu-item">
            <span class="menu-icon">ðŸšª</span>
            Sign Out
          </button>
        </div>
      }
    </div>
  </header>
  
  <main class="dashboard-content">
    <div class="dashboard-card">
      <h2>Dashboard</h2>
      <p>You have successfully logged in to the application.</p>
      <div class="user-info">
        <h3>User Information</h3>
        <p><strong>Name:</strong> {{ authService.currentUser()?.firstName }} {{ authService.currentUser()?.lastName }}</p>
        <p><strong>Email:</strong> {{ authService.currentUser()?.primaryEmail }}</p>
        <p><strong>Role:&nbsp;&nbsp;</strong> 
          @if (authService.currentUser()?.state === 'admin') {
            <span class="role-badge admin">Administrator</span>
          } @else if (authService.currentUser()?.state === 'active') {
            <span class="role-badge active">Active User</span>
          } @else {
            <span class="role-badge {{ authService.currentUser()?.state }}">{{ authService.currentUser()?.state | titlecase }}</span>
          }
        </p>
      </div>
    </div>

    <div class="dashboard-card">
      <div class="my-teams-header">
        <button 
          class="collapsible-header" 
          (click)="toggleMyTeams()"
          [class.active]="showMyTeams()">
          <span class="chevron">{{ showMyTeams() ? 'â–¼' : 'â–¶' }}</span>
          <h2>My Teams</h2>
        </button>
        <button (click)="openCreateTeamDialog()" class="create-team-button">
          <span class="plus-icon">+</span> Create Team
        </button>
      </div>
      
      @if (showMyTeams()) {
        <div class="collapsible-content">
          @if (isLoadingTeams()) {
            <p class="loading-message">Loading teams...</p>
          } @else if (teamsService.userTeams().length === 0) {
            <p class="empty-message">You haven't joined any teams yet. Create a new team to get started!</p>
          } @else {
            <div class="teams-grid">
              @for (team of teamsService.userTeams(); track team.id) {
                <div class="team-card clickable" [class.admin]="isTeamAdmin(team.id)" (click)="viewTeam(team.id)">
                  <div class="team-card-header">
                    <h3>{{ team.name }}</h3>
                    <div class="badges">
                      @if (isTeamAdmin(team.id)) {
                        <span class="admin-badge">Admin</span>
                      }
                      <span class="visibility-badge {{ team.visibility }}">{{ team.visibility | titlecase }}</span>
                    </div>
                  </div>
                  @if (team.description) {
                    <p class="team-description">{{ team.description }}</p>
                  }
                  <div class="team-meta">
                    <span class="member-count">{{ team.memberCount || 0 }} member{{ (team.memberCount || 0) === 1 ? '' : 's' }}</span>
                    @if (team.pendingCount && team.pendingCount > 0) {
                      <span class="pending-count">{{ team.pendingCount }} pending</span>
                    }
                  </div>
                </div>
              }
            </div>
          }
        </div>
      }
    </div>

    @if (isAdmin()) {
      <div class="dashboard-card">
        <button 
          class="collapsible-header" 
          (click)="toggleAllUsers()"
          [class.active]="showAllUsers()">
          <span class="chevron">{{ showAllUsers() ? 'â–¼' : 'â–¶' }}</span>
          <h2>All Users</h2>
        </button>
        
        @if (showAllUsers()) {
          <div class="collapsible-content">
            <input 
              type="text"
              [(ngModel)]="userSearchFilter"
              placeholder="Search users..."
              class="user-search-input"
            />
            
            @if (isLoadingUsers()) {
              <p class="loading-message">Loading users...</p>
            } @else if (allUsers().length === 0) {
              <p class="empty-message">No users found.</p>
            } @else {
              <div class="users-table-container">
                <table class="users-table">
                  <thead>
                    <tr>
                      <th class="sortable" (click)="sortUsers('firstName')">
                        First Name <span class="sort-icon">{{ getSortIcon('firstName') }}</span>
                      </th>
                      <th class="sortable" (click)="sortUsers('lastName')">
                        Last Name <span class="sort-icon">{{ getSortIcon('lastName') }}</span>
                      </th>
                      <th class="sortable" (click)="sortUsers('email')">
                        Email <span class="sort-icon">{{ getSortIcon('email') }}</span>
                      </th>
                      <th>State</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (user of sortedUsers(); track user.id) {
                      <tr>
                        <td>{{ user.firstName }}</td>
                        <td>{{ user.lastName }}</td>
                        <td>{{ user.primaryEmail }}</td>
                        <td>
                          @if (user.state === 'admin') {
                            <span class="role-badge admin">Administrator</span>
                          } @else if (user.state === 'active') {
                            <span class="role-badge active">Active</span>
                          } @else if (user.state === 'pending') {
                            <span class="role-badge pending">Pending</span>
                          } @else if (user.state === 'disabled') {
                            <span class="role-badge disabled">Disabled</span>
                          } @else {
                            <span class="role-badge {{ user.state }}">{{ user.state | titlecase }}</span>
                          }
                        </td>
                        <td>
                          <button (click)="viewUserProfile(user.id)" class="view-profile-button">
                            View Profile
                          </button>
                        </td>
                      </tr>
                    }
                  </tbody>
                </table>
              </div>
            }
          </div>
        }
      </div>
    }

    @if (teamsService.pendingTeams().length > 0) {
      <div class="dashboard-card">
        <button 
          class="collapsible-header" 
          (click)="togglePendingTeams()"
          [class.active]="showPendingTeams()">
          <span class="chevron">{{ showPendingTeams() ? 'â–¼' : 'â–¶' }}</span>
          <h2>Pending Team Requests</h2>
        </button>
        
        @if (showPendingTeams()) {
          <div class="collapsible-content">
            @if (isLoadingPendingTeams()) {
              <p class="loading-message">Loading pending requests...</p>
            } @else {
              <div class="teams-grid">
                @for (team of teamsService.pendingTeams(); track team.id) {
                  <div class="team-card pending">
                    <div class="team-card-header">
                      <h3>{{ team.name }}</h3>
                      <span class="status-badge pending">Pending Approval</span>
                    </div>
                    @if (team.description) {
                      <p class="team-description">{{ team.description }}</p>
                    }
                    <div class="team-meta">
                      <span class="member-count">{{ team.memberCount || 0 }} member{{ (team.memberCount || 0) === 1 ? '' : 's' }}</span>
                    </div>
                    <p class="pending-info">Your request to join this team is awaiting approval from a team administrator.</p>
                  </div>
                }
              </div>
            }
          </div>
        }
      </div>
    }

    <div class="dashboard-card">
      <button 
        class="collapsible-header" 
        (click)="togglePublicTeams()"
        [class.active]="showPublicTeams()">
        <span class="chevron">{{ showPublicTeams() ? 'â–¼' : 'â–¶' }}</span>
        <h2>Available Public Teams ({{ teamsService.publicTeams().length }})</h2>
      </button>
      
      @if (showPublicTeams()) {
        <div class="collapsible-content">
          <input 
            type="text"
            [(ngModel)]="publicTeamsSearchFilter"
            placeholder="Search teams by name, number, or description..."
            class="team-search-input"
          />
          
          @if (isLoadingPublicTeams()) {
            <p class="loading-message">Loading public teams...</p>
          } @else if (filteredPublicTeams().length === 0) {
            @if (publicTeamsSearchFilter() === '') {
              <p class="empty-message">No public teams available to join.</p>
            } @else {
              <p class="empty-message">No teams match your search.</p>
            }
          } @else {
            <div class="teams-grid">
              @for (team of filteredPublicTeams(); track team.id) {
                <div class="team-card public">
                  <div class="team-card-header">
                    <h3>{{ team.name }} <span class="team-number-badge">#{{ team.teamNumber }}</span></h3>
                  </div>
                  @if (team.description) {
                    <p class="team-description">{{ team.description }}</p>
                  }
                  <div class="team-meta">
                    <span class="member-count">{{ team.memberCount || 0 }} member{{ (team.memberCount || 0) === 1 ? '' : 's' }}</span>
                    @if (team.pendingCount && team.pendingCount > 0) {
                      <span class="pending-count">{{ team.pendingCount }} pending</span>
                    }
                  </div>
                  <button 
                    (click)="joinTeam(team.id)" 
                    class="join-button"
                    [disabled]="isJoiningTeam()">
                    {{ isJoiningTeam() ? 'Requesting...' : 'Request to Join' }}
                  </button>
                </div>
              }
            </div>
          }
        </div>
      }
    </div>
  </main>
</div>

@if (showCreateTeamDialog()) {
  <div class="dialog-overlay" (click)="closeCreateTeamDialog()">
    <div class="dialog-content" (click)="$event.stopPropagation()">
      <div class="dialog-header">
        <h2>Create New Team</h2>
        <button class="close-button" (click)="closeCreateTeamDialog()">Ã—</button>
      </div>

      <form [formGroup]="createTeamForm" (ngSubmit)="onCreateTeam()" class="create-team-form">
        <div class="form-group">
          <label for="teamName">Team Name *</label>
          <input 
            id="teamName"
            type="text" 
            formControlName="name"
            [class.error]="getFieldError('name')"
            placeholder="Enter team name"
          />
          @if (getFieldError('name')) {
            <span class="error-message">{{ getFieldError('name') }}</span>
          }
        </div>

        <div class="form-group">
          <label for="teamNumber">Team Number *</label>
          <input 
            id="teamNumber"
            type="number" 
            formControlName="teamNumber"
            [class.error]="getFieldError('teamNumber')"
            placeholder="Enter team number (1-30000)"
            min="1"
            max="30000"
          />
          @if (getFieldError('teamNumber')) {
            <span class="error-message">{{ getFieldError('teamNumber') }}</span>
          }
        </div>

        <div class="form-group">
          <label for="teamDescription">Description</label>
          <textarea 
            id="teamDescription"
            formControlName="description"
            rows="3"
            placeholder="Describe your team's purpose"
          ></textarea>
        </div>

        <div class="form-group">
          <label for="visibility">Visibility *</label>
          <select id="visibility" formControlName="visibility">
            <option value="private">Private - Only invited members can join</option>
            <option value="public">Public - Anyone can join</option>
          </select>
        </div>

        @if (createTeamError()) {
          <div class="alert-error">
            {{ createTeamError() }}
          </div>
        }

        <div class="dialog-actions">
          <button 
            type="button" 
            class="cancel-button"
            (click)="closeCreateTeamDialog()"
            [disabled]="isCreatingTeam()">
            Cancel
          </button>
          <button 
            type="submit" 
            class="submit-button"
            [disabled]="createTeamForm.invalid || isCreatingTeam()">
            {{ isCreatingTeam() ? 'Creating...' : 'Create Team' }}
          </button>
        </div>
      </form>
    </div>
  </div>
}

@if (showInvitationNotification()) {
  <div class="dialog-overlay" (click)="closeInvitationNotification()">
    <div class="dialog-content invitation-notification" (click)="$event.stopPropagation()">
      <div class="dialog-header">
        <h2>Team Invitations</h2>
        <button class="close-button" (click)="closeInvitationNotification()">Ã—</button>
      </div>

      <div class="notification-content">
        <p class="notification-message">
          You have been invited to join the following team(s). Accept to request membership (admin approval required):
        </p>

        <div class="invitations-list">
          @for (invitation of pendingInvitations(); track invitation.id) {
            <div class="invitation-card">
              <div class="invitation-info">
                <h3>{{ invitation.teamName }}</h3>
                <p class="invitation-email">Invited to: {{ invitation.email }}</p>
                <p class="invitation-date">Sent: {{ invitation.createdAt | date:'short' }}</p>
              </div>
              <div class="invitation-actions">
                <button 
                  class="accept-button"
                  (click)="acceptInvitation(invitation.id)">
                  Accept
                </button>
                <button 
                  class="decline-button"
                  (click)="declineInvitation(invitation.id)">
                  Decline
                </button>
              </div>
            </div>
          }
        </div>

        <div class="dialog-actions">
          <button 
            class="cancel-button"
            (click)="closeInvitationNotification()">
            Close
          </button>
        </div>
      </div>
    </div>
  </div>
}

@if (showChangePasswordDialog()) {
  <div class="dialog-overlay" (click)="closeChangePasswordDialog()">
    <div class="dialog-content" (click)="$event.stopPropagation()">
      <div class="dialog-header">
        <h2>Change Password</h2>
        <button class="close-button" (click)="closeChangePasswordDialog()">Ã—</button>
      </div>

      <form [formGroup]="changePasswordForm" (ngSubmit)="onChangePassword()" class="change-password-form">
        <div class="form-group">
          <label for="currentPassword">Current Password *</label>
          <input 
            id="currentPassword"
            type="password" 
            formControlName="currentPassword"
            [class.error]="getPasswordFieldError('currentPassword')"
            placeholder="Enter your current password"
          />
          @if (getPasswordFieldError('currentPassword')) {
            <span class="error-message">{{ getPasswordFieldError('currentPassword') }}</span>
          }
        </div>

        <div class="form-group">
          <label for="newPassword">New Password *</label>
          <input 
            id="newPassword"
            type="password" 
            formControlName="newPassword"
            [class.error]="getPasswordFieldError('newPassword')"
            placeholder="Enter your new password"
          />
          
          <div class="password-requirements">
            <p class="requirements-title">Password must contain:</p>
            <div class="requirement" [class.met]="hasMinLength()">
              <span class="requirement-icon">{{ hasMinLength() ? 'âœ“' : 'âœ—' }}</span>
              At least 8 characters
            </div>
            <div class="requirement" [class.met]="hasUpperCase()">
              <span class="requirement-icon">{{ hasUpperCase() ? 'âœ“' : 'âœ—' }}</span>
              At least one uppercase letter
            </div>
            <div class="requirement" [class.met]="hasLowerCase()">
              <span class="requirement-icon">{{ hasLowerCase() ? 'âœ“' : 'âœ—' }}</span>
              At least one lowercase letter
            </div>
            <div class="requirement" [class.met]="hasNumber()">
              <span class="requirement-icon">{{ hasNumber() ? 'âœ“' : 'âœ—' }}</span>
              At least one number
            </div>
            <div class="requirement" [class.met]="hasSymbol()">
              <span class="requirement-icon">{{ hasSymbol() ? 'âœ“' : 'âœ—' }}</span>
              At least one special character
            </div>
          </div>
        </div>

        <div class="form-group">
          <label for="confirmPassword">Confirm New Password *</label>
          <input 
            id="confirmPassword"
            type="password" 
            formControlName="confirmPassword"
            [class.error]="getPasswordFieldError('confirmPassword')"
            placeholder="Confirm your new password"
          />
          @if (getPasswordFieldError('confirmPassword')) {
            <span class="error-message">{{ getPasswordFieldError('confirmPassword') }}</span>
          }
        </div>

        @if (changePasswordError()) {
          <div class="alert-error">
            {{ changePasswordError() }}
          </div>
        }

        @if (changePasswordSuccess()) {
          <div class="alert-success">
            {{ changePasswordSuccess() }}
          </div>
        }

        <div class="dialog-actions">
          <button 
            type="button" 
            class="cancel-button"
            (click)="closeChangePasswordDialog()"
            [disabled]="isChangingPassword()">
            Cancel
          </button>
          <button 
            type="submit" 
            class="submit-button"
            [disabled]="changePasswordForm.invalid || isChangingPassword()">
            {{ isChangingPassword() ? 'Changing...' : 'Change Password' }}
          </button>
        </div>
      </form>
    </div>
  </div>
}
