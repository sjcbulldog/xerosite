<div class="dashboard-container">
  <header class="dashboard-header">
    <h1>Welcome, {{ authService.currentUser()?.firstName || 'User' }}!</h1>
    <div class="user-menu-container">
      <button (click)="toggleUserMenu()" class="user-menu-button">
        <span class="user-initials">{{ authService.currentUser()?.firstName?.charAt(0) }}{{ authService.currentUser()?.lastName?.charAt(0) }}</span>
        <span class="chevron-down">â–¼</span>
      </button>
      @if (showUserMenu()) {
        <div class="user-menu-dropdown">
          <button (click)="navigateToProfile()" class="menu-item">
            <span class="menu-icon">ðŸ‘¤</span>
            Edit Profile
          </button>
          <button (click)="logout()" class="menu-item">
            <span class="menu-icon">ðŸšª</span>
            Sign Out
          </button>
        </div>
      }
    </div>
  </header>
  
  <main class="dashboard-content">
    <div class="dashboard-card">
      <h2>Dashboard</h2>
      <p>You have successfully logged in to the application.</p>
      <div class="user-info">
        <h3>User Information</h3>
        <p><strong>Name:</strong> {{ authService.currentUser()?.firstName }} {{ authService.currentUser()?.lastName }}</p>
        <p><strong>Email:</strong> {{ authService.currentUser()?.primaryEmail }}</p>
        <p><strong>Role:&nbsp;&nbsp;</strong> 
          @if (authService.currentUser()?.state === 'admin') {
            <span class="role-badge admin">Administrator</span>
          } @else if (authService.currentUser()?.state === 'active') {
            <span class="role-badge active">Active User</span>
          } @else {
            <span class="role-badge {{ authService.currentUser()?.state }}">{{ authService.currentUser()?.state | titlecase }}</span>
          }
        </p>
      </div>
    </div>

    <div class="dashboard-card">
      <div class="teams-header">
        <h2>My Teams</h2>
        <button (click)="openCreateTeamDialog()" class="create-team-button">
          <span class="plus-icon">+</span> Create Team
        </button>
      </div>
      
      @if (isLoadingTeams()) {
        <p class="loading-message">Loading teams...</p>
      } @else if (teamsService.userTeams().length === 0) {
        <p class="empty-message">You haven't joined any teams yet. Create a new team to get started!</p>
      } @else {
        <div class="teams-grid">
          @for (team of teamsService.userTeams(); track team.id) {
            <div class="team-card clickable" [class.admin]="isTeamAdmin(team.id)" (click)="viewTeam(team.id)">
              <div class="team-card-header">
                <h3>{{ team.name }}</h3>
                <div class="badges">
                  @if (isTeamAdmin(team.id)) {
                    <span class="admin-badge">Admin</span>
                  }
                  <span class="visibility-badge {{ team.visibility }}">{{ team.visibility | titlecase }}</span>
                </div>
              </div>
              @if (team.description) {
                <p class="team-description">{{ team.description }}</p>
              }
              <div class="team-meta">
                <span class="member-count">{{ team.memberCount || 0 }} member{{ (team.memberCount || 0) === 1 ? '' : 's' }}</span>
                @if (team.pendingCount && team.pendingCount > 0) {
                  <span class="pending-count">{{ team.pendingCount }} pending</span>
                }
              </div>
            </div>
          }
        </div>
      }
    </div>

    <div class="dashboard-card">
      <button 
        class="collapsible-header" 
        (click)="togglePendingTeams()"
        [class.active]="showPendingTeams()">
        <span class="chevron">{{ showPendingTeams() ? 'â–¼' : 'â–¶' }}</span>
        <h2>Pending Team Requests</h2>
      </button>
      
      @if (showPendingTeams()) {
        <div class="collapsible-content">
          @if (isLoadingPendingTeams()) {
            <p class="loading-message">Loading pending requests...</p>
          } @else if (teamsService.pendingTeams().length === 0) {
            <p class="empty-message">No pending team requests.</p>
          } @else {
            <div class="teams-grid">
              @for (team of teamsService.pendingTeams(); track team.id) {
                <div class="team-card pending">
                  <div class="team-card-header">
                    <h3>{{ team.name }}</h3>
                    <span class="status-badge pending">Pending Approval</span>
                  </div>
                  @if (team.description) {
                    <p class="team-description">{{ team.description }}</p>
                  }
                  <div class="team-meta">
                    <span class="member-count">{{ team.memberCount || 0 }} member{{ (team.memberCount || 0) === 1 ? '' : 's' }}</span>
                  </div>
                  <p class="pending-info">Your request to join this team is awaiting approval from a team administrator.</p>
                </div>
              }
            </div>
          }
        </div>
      }
    </div>

    <div class="dashboard-card">
      <button 
        class="collapsible-header" 
        (click)="togglePublicTeams()"
        [class.active]="showPublicTeams()">
        <span class="chevron">{{ showPublicTeams() ? 'â–¼' : 'â–¶' }}</span>
        <h2>Available Public Teams</h2>
      </button>
      
      @if (showPublicTeams()) {
        <div class="collapsible-content">
          @if (isLoadingPublicTeams()) {
            <p class="loading-message">Loading public teams...</p>
          } @else if (teamsService.publicTeams().length === 0) {
            <p class="empty-message">No public teams available to join.</p>
          } @else {
            <div class="teams-grid">
              @for (team of teamsService.publicTeams(); track team.id) {
                <div class="team-card public">
                  <div class="team-card-header">
                    <h3>{{ team.name }}</h3>
                  </div>
                  @if (team.description) {
                    <p class="team-description">{{ team.description }}</p>
                  }
                  <div class="team-meta">
                    <span class="member-count">{{ team.memberCount || 0 }} member{{ (team.memberCount || 0) === 1 ? '' : 's' }}</span>
                    @if (team.pendingCount && team.pendingCount > 0) {
                      <span class="pending-count">{{ team.pendingCount }} pending</span>
                    }
                  </div>
                  <button 
                    (click)="joinTeam(team.id)" 
                    class="join-button"
                    [disabled]="isJoiningTeam()">
                    {{ isJoiningTeam() ? 'Requesting...' : 'Request to Join' }}
                  </button>
                </div>
              }
            </div>
          }
        </div>
      }
    </div>
  </main>
</div>

@if (showCreateTeamDialog()) {
  <div class="dialog-overlay" (click)="closeCreateTeamDialog()">
    <div class="dialog-content" (click)="$event.stopPropagation()">
      <div class="dialog-header">
        <h2>Create New Team</h2>
        <button class="close-button" (click)="closeCreateTeamDialog()">Ã—</button>
      </div>

      <form [formGroup]="createTeamForm" (ngSubmit)="onCreateTeam()" class="create-team-form">
        <div class="form-group">
          <label for="teamName">Team Name *</label>
          <input 
            id="teamName"
            type="text" 
            formControlName="name"
            [class.error]="getFieldError('name')"
            placeholder="Enter team name"
          />
          @if (getFieldError('name')) {
            <span class="error-message">{{ getFieldError('name') }}</span>
          }
        </div>

        <div class="form-group">
          <label for="teamNumber">Team Number *</label>
          <input 
            id="teamNumber"
            type="number" 
            formControlName="teamNumber"
            [class.error]="getFieldError('teamNumber')"
            placeholder="Enter team number (1-30000)"
            min="1"
            max="30000"
          />
          @if (getFieldError('teamNumber')) {
            <span class="error-message">{{ getFieldError('teamNumber') }}</span>
          }
        </div>

        <div class="form-group">
          <label for="teamDescription">Description</label>
          <textarea 
            id="teamDescription"
            formControlName="description"
            rows="3"
            placeholder="Describe your team's purpose"
          ></textarea>
        </div>

        <div class="form-group">
          <label for="visibility">Visibility *</label>
          <select id="visibility" formControlName="visibility">
            <option value="private">Private - Only invited members can join</option>
            <option value="public">Public - Anyone can join</option>
          </select>
        </div>

        @if (createTeamError()) {
          <div class="alert-error">
            {{ createTeamError() }}
          </div>
        }

        <div class="dialog-actions">
          <button 
            type="button" 
            class="cancel-button"
            (click)="closeCreateTeamDialog()"
            [disabled]="isCreatingTeam()">
            Cancel
          </button>
          <button 
            type="submit" 
            class="submit-button"
            [disabled]="createTeamForm.invalid || isCreatingTeam()">
            {{ isCreatingTeam() ? 'Creating...' : 'Create Team' }}
          </button>
        </div>
      </form>
    </div>
  </div>
}
