<div class="dialog-overlay">
  <div class="dialog-content" (click)="$event.stopPropagation()">
    <div class="dialog-header">
      <h2>Preferences</h2>
      <button class="close-button" (click)="closeDialog()" aria-label="Close">&times;</button>
    </div>

    @if (isAdmin()) {
      <div class="tabs">
        <button 
          type="button"
          [class.active]="activeTab() === 'user'"
          (click)="setActiveTab('user')"
          class="tab-button">
          User
        </button>
        <button 
          type="button"
          [class.active]="activeTab() === 'site'"
          (click)="setActiveTab('site')"
          class="tab-button">
          Site
        </button>
      </div>
    }

    <div class="preferences-form">
      @if (errorMessage()) {
        <div class="error-banner">
          {{ errorMessage() }}
        </div>
      }

      <!-- User Preferences Tab -->
      @if (activeTab() === 'user') {
        <!-- Event Notifications Section -->
        <div class="preference-section">
          <h3>Event Notifications</h3>
          <p class="section-description">
            Configure when you want to be notified before scheduled events.
          </p>

          @if (eventNotifications().length === 0) {
            <p class="empty-state">No notification preferences set. Click "Add Notification" to create one.</p>
          }

          @for (notification of eventNotifications(); track $index) {
            <div class="notification-item">
              <div class="notification-controls">
                <div class="form-group">
                  <label>Notify me</label>
                  <select 
                    [value]="notification.timeBefore" 
                    (change)="updateNotificationTime($index, $any($event.target).value)"
                    class="time-select">
                    @for (option of timeOptions; track option.value) {
                      <option [value]="option.value">{{ option.label }}</option>
                    }
                  </select>
                </div>

                <div class="form-group">
                  <label>Via</label>
                  <div class="method-buttons">
                    <button 
                      type="button"
                      [class.active]="notification.method === 'email'"
                      (click)="updateNotificationMethod($index, 'email')"
                      class="method-button">
                      Email
                    </button>
                    <button 
                      type="button"
                      [class.active]="notification.method === 'text'"
                      (click)="updateNotificationMethod($index, 'text')"
                      class="method-button">
                      Text
                    </button>
                  </div>
                </div>

                <button 
                  type="button"
                  (click)="removeNotification($index)" 
                  class="remove-button"
                  aria-label="Remove notification">
                  &times;
                </button>
              </div>
            </div>
          }

          <button type="button" (click)="addNotification()" class="add-button">
            + Add Notification
          </button>
        </div>
      }

      <!-- Site Preferences Tab -->
      @if (activeTab() === 'site') {
        <div class="preference-section">
          <h3>Idle Timeout</h3>
          <p class="section-description">
            Set the number of minutes of inactivity before users are automatically logged out.
          </p>

          <div class="form-group">
            <label>Timeout (minutes)</label>
            <input 
              type="number" 
              [value]="idleTimeout()" 
              (input)="idleTimeout.set(+$any($event.target).value)"
              min="5"
              max="120"
              class="timeout-input">
          </div>
        </div>
      }

      <!-- Action Buttons -->
      <div class="dialog-actions">
        <button type="button" (click)="closeDialog()" class="cancel-button" [disabled]="loading()">
          Cancel
        </button>
        <button type="button" (click)="savePreferences()" class="save-button" [disabled]="loading()">
          @if (loading()) {
            <span>Saving...</span>
          } @else {
            <span>Save Preferences</span>
          }
        </button>
      </div>
    </div>
  </div>
</div>
